<!DOCTYPE html>
<html lang="ru">
<head>
  <title>ESPShell: Частотомер и счётчик импульсов</title>
  <link rel="stylesheet" href="espshell.css">
</head>
<body>
<p align=center><a href="index.ru.html"><img src="i/espshell_logo.jpg" alt="ESPShell для Arduino :: Главная" width="70%" height="70%" /></a></p>
<p>
  <ul>
    <li><a href="#pc">Счётчик импульсов / частотомер</a></li>
    <li><a href="#simple">Простая форма: интервал измерения</a></li>
    <li><a href="#trigger">Ключевое слово "<b>trigger</b>": подождать и потом считать</a></li>
    <li><a href="#filter">Ключевое слово "<b>filter</b>": игнорировать короткие импульсы</a></li>
    <li><a href="#parallel">Параллельная работа счётчиков</a></li>
    <li><a href="#stopping">Остановка работающего счётчика</a></li>
    <li><a href="#show">Просмотр состояния счётчиков</a></li>
    <li><a href="#clear">Сброс счётчиков</a></li>
    <li><a href="#examples">Примеры</a></li>
  </ul>
</p>

<p><h2 id=pc><a href="#top">&#8686;</a>СЧЁТЧИК ИМПУЛЬСОВ / ЧАСТОТОМЕР</h2></p>

<p>
ESP32 содержит встроенный аппаратный модуль подсчёта импульсов, состоящий из 8 (в оригинальной ESP32) или меньше (в новых моделях) блоков PCNT (см. техническое описание ESP32). Эти счётчики могут работать параллельно, обеспечивая до 8 независимых частотомеров или счётчиков импульсов.
</p>

<p>
Управление счётчиками осуществляется двумя командами: "<b>count</b>" и "<b>show counters</b>".
</p>
<p>
Команда "<b>count</b>" используется для подсчёта импульсов на выбранном пине. Она принимает несколько аргументов:
</p>
<p>
<ul>
  <li>Номер пина (обязательный)</li>
  <li>Интервал измерения (по умолчанию 1 секунда)</li>
  <li>Ключевые слова ("trigger" и "filter")</li>
</ul>
</p>

<p>
Синтаксис команды:
</p>

<p>
  <b>count</b> <i>PIN</i> [ <i>TIME_MS</i> | infinite | trigger | filter <i>NANOSECONDS</i> ]* 
</p>

<p>
PIN — номер пина, TIME_MS — длительность измерения в миллисекундах (по умолчанию 1000 мс). Ключевое слово "infinite" задаёт очень большую длительность (см. примеры ниже).
</p>

<p>
Порядок аргументов не важен, команды "<b>count 4 trigger infinite</b>" и "<b>count 4 infinite trigger</b>" идентичны.
</p>

<p>
Ключевое слово "<b>trigger</b>" заставляет счётчик ждать первого импульса перед началом измерения. Это полезно, если источник импульсов — не постоянный генератор.
</p>

<p>
Ключевое слово "<b>filter</b> <i>NANOSECONDS</i>" позволяет игнорировать импульсы короче указанного порога.
</p>


<p><h2 id=simple><a href="#top">&#8686;</a>ПРОСТАЯ ФОРМА: ИНТЕРВАЛ ИЗМЕРЕНИЯ</h2></p>
<p>
В самой простой форме команда "count" требует только номер пина.
</p>
<p>
  Пример: измерение частоты на пине #2
<pre>
  esp32#>count 2
  % Counting pulses on GPIO2...(press <Enter> to stop)
  % 0 pulses in 1.000 seconds (0.0 Hz, 0 IRQs)
  esp32#>
</pre>
</p>

<p>
По умолчанию ESPShell измеряет в течение 1000 мс. Для низкочастотных сигналов можно указать более длительный интервал:
</p>

<p>
  Пример: считать импульсы на пине #2 за 10 секунд
<pre>
  esp32#>count 2 10000
  % Counting pulses on GPIO2...(press <Enter> to stop)
  % 0 pulses in 10.000 seconds (0.0 Hz, 0 IRQs)
  esp32#>
</pre>
</p>

<p>
Также можно использовать ключевое слово "infinite" вместо числа: "count 2 infinite". Это задаёт длительность 2<sup>64</sup> микросекунд — практически безлимитную.
</p>

<p><h2 id=trigger><a href="#top">&#8686;</a>КЛЮЧЕВОЕ СЛОВО "TRIGGER": ПОДОЖДАТЬ И ПОТОМ СЧИТАТЬ</h2></p>
<p>
Рассмотрим ситуацию: пользователь запускает счёт на пине #4, а затем подключает к нему ШИМ-сигнал. Счётчик начнёт работать раньше, чем появятся импульсы, и результат будет искажен: хотя количество импульсов будет посчитано правильно, но частота будет определена неверно.
</p>

<p>
Вместо простой команды "<b>count 4</b>" рекомендуется использовать "<b>trigger</b>", чтобы отсчёт начался только с первого импульса.
</p>

<p><h2 id=filter><a href="#top">&#8686;</a>КЛЮЧЕВОЕ СЛОВО "FILTER": ИГНОРИРОВАТЬ КОРОТКИЕ ИМПУЛЬСЫ</h2></p>

<p>
Можно игнорировать импульсы короче заданного порога с помощью "filter":
</p>
<p>
<pre>
  esp32#> count 4 filter 100
</pre>
</p>

<p>
Команда выше **игнорирует** импульсы короче 100 нс.
</p>

<p>
Минимальное значение фильтра зависит от частоты шины APB (обычно 80 МГц), то есть 25 нс. Максимальное — около 25 700 нс.
</p>

<p>
Фильтрация полезна, например, для подавления дребезга кнопок.
</p>

<p>
Чтобы узнать допустимые значения, введите команду без значения:
<pre>
    esp32#>count 4 filter
    % Filter time in nanoseconds is expected [25 .. 25575]
    % Step is 25ns; values like 125 or 149 will be rounded
    % Missing arguments. ("? count" for help)
    esp32#>
</pre>
</p>

<p>
Пример:
Подключите выход ШИМ на пине #2 (10 МГц) к пину #4:
<pre>
    esp32#>pwm 2 10000000
    esp32#>
    esp32#>count 4 filter 300
    % Counting pulses on GPIO4...(press <Enter> to stop)
    % 0 pulses in 1.001 seconds (0 Hz, 0 IRQs)
</pre>
</p>

<p>
Сигнал (ширина 100 нс) короче фильтра (300 нс), он игнорируется.
</p>

<p>
Теперь уменьшим фильтр до 50 нс:
<pre>
    esp32#>count 4 filter 50  
    % Counting pulses on GPIO4...(press <Enter> to stop)
    % 10000000 pulses in 1.000 seconds (10000000 Hz, 500 IRQs)
</pre>
</p>

<p>
Теперь импульсы учитываются.
</p>


<p><h2 id=parallel><a href="#top">&#8686;</a>ПАРАЛЛЕЛЬНАЯ РАБОТА СЧЁТЧИКОВ</h2></p>

<p>
Команда "count" блокирует дальнейший ввод до завершения. Чтобы запустить её в фоне, используйте <a href="Basics.html#background">символ "&"</a>.
</p><p>
Это удобно для длительных или бесконечных измерений, например, для отслеживания срабатывания дверного датчика. При этом вы можете продолжать вводить команды.
</p><p>
  Пример: считать импульсы 1 000 000 мс (в фоновом режиме)
<pre>
  esp32#>count  4  1000000 &     
  % Background task started
  % Use "kill 0x3ffb8ce4" to stop
  % Counting pulses on GPIO4...
  esp32#>
  esp32#>kill 0x3ffb8ce4          
  % 0 pulses in 11.895 seconds (0.0 Hz, 0 IRQs)
  % Command "count" finished
  esp32#>
</pre>
</p><p>  
  Подсказка: выделите мышкой и вставьте команду "kill"
</p>


<p><h2 id=stopping><a href="#top">&#8686;</a>ОСТАНОВКА РАБОТАЮЩЕГО СЧЁТЧИКА</h2></p>

<p>
Вы можете прервать подсчёт в любой момент нажатием <Enter> в терминале или Serial Monitor. Для фонового режима используйте команду "kill":
</p><p>
    Пример: запустить счётчик и остановить его:
<pre>
    esp32#>count 4 999999 &               
    % Background task started
    % Use "kill 0x3fca3914" to stop
    % Counting pulses on GPIO4...
    esp32#>
    esp32#>kill 0x3fca3914                
    % 0 pulses in 8.984 seconds (0 Hz, 0 IRQs)
    % Command "count" finished
    esp32#>
</pre></p><p>
Остановка безопасна — накопленные данные сохраняются.
</p>


<p><h2 id=show><a href="#top">&#8686;</a>ПРОСМОТР СОСТОЯНИЯ СЧЁТЧИКОВ</h2></p>

<p>
Для получения текущего состояния используйте команду "show counters". Она работает только для запущенных в фоне счётчиков.
</p>

<p align=center>
<img src="i/show_counters.jpg" width="70%" height="70%" alt="show counters" /><br>
<i>Рис. 1: вывод команды "<b>show counters</b>"</i>
</p>

<p>
"<b>PCNT</b>" — номер аппаратного счётчика. "Status" — текущее состояние: "Trigger", "Running" или "Stopped". "TaskID" — ID фоновой задачи, пригодный для "kill", "suspend", "resume" (последние две — только для фоновых задач).
</p><p>
"Time, msec" — сколько времени прошло с начала подсчёта. Для режима "trigger" отсчёт начинается с первого импульса.
</p><p>
"Filter, ns" — активный фильтр или "-off-", если не установлен.
</p>


<p><h2 id=clear><a href="#top">&#8686;</a>СБРОС СЧЁТЧИКОВ</h2></p>
<p>
Для сброса счётчика (работающего или остановленного) используйте команду "<b>count</b> <i>PIN</i> <b>clear</b>". Она сбрасывает все счётчики, привязанные к указанному пину.
</p>


<p><h2 id=examples><a href="#top">&#8686;</a>ПРИМЕР</h2></p>

<p>
Соедините пины 2 и 4 перемычкой. Запустите генерацию ШИМ на пине 2 и счёт на пине 4:
</p>

<p>
  Пример: запустить ШИМ и измерить его частоту
<pre>
  esp32#>pwm 2 20000
  esp32#>count  4
  % Counting pulses on GPIO4...(press <Enter> to stop)
  % 20000 pulses in 1.000 seconds (20000.0 Hz, 0 IRQs)
  esp32#>
</pre>
</p>

<p>
Это удобно для проверки сигналов, генерируемых на пинах ESP32.
</p>
</body>
</html>
