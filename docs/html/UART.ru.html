<!DOCTYPE html>
<html lang="ru">
<head>
  <title>ESPShell: UART</title>
  <link rel="stylesheet" href="espshell.css">
</head>
<body>
<p align=center><a href="index.ru.html"><img src="i/espshell_logo.jpg" alt="ESPShell для Arduino :: UART" width="70%" height="70%" /></a></p>
<h3 align=center><a href="UART.ru.html">[ На русском ]</a>&nbsp;&harr;&nbsp;<a href="UART.html">[ English ]</a></h3>
<ul>
  <li><a href="#uarts">UART на ESP32</a></li>
  <li><a href="#send">Инициализация UART: передача и приём данных</a></li>
  <li><a href="#tap">UART-мост: взаимодействие с модемами и GPS</a></li>
</ul>

<h2 id=uarts><a href="#top">&#8686;</a>UART на ESP32</h2>

<p>
ESP32 имеет до 3 аппаратных UART в зависимости от модели (обычный ESP32 имеет 3 UART, а ESP32-S2 — два). UART0 используется в качестве основного порта ввода/вывода как для прошивки, так и для ввода/вывода скетча. В среде Arduino он обозначается как <span class=func>Serial0</span> или <span class=func>Serial</span>. (На платах с поддержкой USB-OTG основным портом ввода/вывода выступает USB.)
</p><p>
При запуске ESPShell ожидает инициализации <span class=func>Serial</span> скетчем. Обычно это делается в <span class=func>setup()</span>, например так:
</p><p>
<pre>
void setup() {
  ....
  Serial.begin(115200);
  ....
}
</pre>
</p><p>
Как только ESPShell обнаружит, что <span class=func>Serial</span> работает, он начнёт принимать и выполнять команды пользователя.
</p><p>
Основная идея — упростить отладку связи по UART между ESP32 и другим устройством (например, GSM-модемом или GPS-модулем). Команды UART позволяют инициализировать интерфейс UART на произвольных пинах и взаимодействовать с подключённым устройством.
</p><p>
Совместно с командой "<b>suspend</b>" это также может быть использовано для перенастройки UART, используемого скетчем (например, для изменения скорости или смены пинов).
</p>

<h2 id=send><a href="#top">&#8686;</a>Инициализация UART: передача и приём данных</h2>

<p>
UART настраивается с помощью команды "<b>uart</b> <i>UART_НОМЕР</i>". После её выполнения приглашение ESPShell меняется с "esp32#>" на "esp32-uartX>", где X — номер UART, что означает переход в режим настройки UART. Ввод "?" и нажатие &lt;Enter&gt; покажет список доступных команд:
</p>
<pre>
 esp32#>ua 1
 esp32-uart1>?
 % Введите "? команда", чтобы получить подробности.
 % Список доступных команд:
 %
 % "?"        : Показать список команд
 % "up"       : Инициализировать UART (пины/скорость)
 % "baud"     : Изменить скорость UART
 % "down"     : Остановить UART
 % "read"     : Прочитать данные из UART
 % "tap"      : Подключиться к устройству по UART
 % "write"    : Отправить байты по UART
 % "exit"     : Выход
 esp32-uart1>
</pre>
<p>
Как видно из вывода выше, доступно 6 команд, специфичных для UART, а также 2 общие команды ("?" и "exit"). Знак вопроса выводит список команд, а "exit" (или Ctrl+Z) завершает режим конфигурации UART.
</p><p>
Также можно использовать глобальные команды внутри контекста UART. Например, команда "<b>pin</b>" работает и в "esp32-uart1>".
</p>

<table>
  <tr><th>Команда</th><th>Описание</th></tr>
  
  <tr><td><p>up</p></td><td>
    <p><b>up</b> <i>RX_PIN</i> <i>TX_PIN</i> <i>СКОРОСТЬ</i> [<i>БИТЫ</i> [no|even|odd [1|1.5|2]]]</p>
    <p>Инициализирует UART. Если UART уже активен, команда ничего не делает.</p>
    <p>Команда требует 3 обязательных параметра (пины RX и TX, скорость) и до 3 необязательных (число бит данных, чётность, стоп-биты).</p>
    <p>Скорость можно изменить позже командой "<b>baud</b>".</p>
    <p>Пока команда "up" не выполнится успешно, другие команды UART использовать нельзя.</p>
    <p>Значения по умолчанию: 8 бит данных, без чётности, 1 стоп-бит.</p>
    <p>Допустимые значения <i>БИТЫ</i>: 5, 6, 7 или 8. Чётность: "no", "even" или "odd". Стоп-биты: 1, 1.5 или 2.</p>
    <p>Пример: инициализация UART2 на пинах 18 и 19 со скоростью 115200:</p>
<pre>
  esp32#>uart 2
  esp32-uart2>up 18 19 115200
</pre>

    <p>Пример: инициализация UART2 на пинах 18 и 19 со скоростью 9600, 8 бит, 1 стоп-бит, чётность "even":</p>
<pre>
  esp32#>uart 2
  esp32-uart2>up 18 19 9600 8 even 1
</pre>

  </td></tr>

  <tr><td><p>down</p></td><td>
    <p><b>down</b></p>
    <p>Останавливает ранее инициализированный UART. Если UART не был активен, команда не делает ничего.</p>
    <p>Примечание: ваш скетч может продолжать использовать UART во время выполнения "down". Используйте глобальную команду "<b>suspend</b>", чтобы приостановить скетч и избежать непредсказуемого поведения.</p>
  </td></tr>

  <tr><td><p>baud</p></td><td>
    <p><b>baud</b> <i>СКОРОСТЬ</i></p>
    <p>Изменяет скорость UART. При изменении скорости UART0 может прерваться связь с монитором порта. Убедитесь, что вы установили ту же скорость на мониторе.</p>
  </td></tr>

  <tr><td><p>read</p></td><td>
    <p><b>read</b></p>
    <p>Читает все доступные на данный момент байты. Печатаемые символы (включая \t, \n, \r) выводятся как есть. Непечатаемые отображаются как "\0xAB", где AB — шестнадцатеричное значение.</p>
  </td></tr>

  <tr><td><p>write</p></td><td>
    <p><b>write</b> <i>ТЕКСТ1</i> <i>ТЕКСТ2</i> ... <i>ТЕКСТn</i></p>
    <p>Отправляет строку байтов по UART. Допустимы печатаемые символы и спецпоследовательности: "\n", "\r", "\t", "\\" для перевода строки, возврата каретки, табуляции и обратного слэша. Можно отправлять произвольные байты через <b>\AB</b>, где AB — hex-код.</p>
    <p>Несколько пробелов сокращаются до одного (команды "<b>write Hello&nbsp;&nbsp;&nbsp;&nbsp;World!</b>" и "<b>write Hello World!</b>" эквивалентны). Чтобы отправить несколько пробелов, используйте "\20" (ASCII 32): "<b>write</b> Hello\20\20\20World!"</p>
    <p>При использовании "<b>write</b>" на UART0 данные отправляются напрямую в монитор порта:</p>

    <p align=center>
      <img src="i/uart0_write.jpg" width="70%" height="70%" alt="Типичное отображение" /><br>
      <i>Рис. 1: команда "write" на UART0</i>
    </p>

    <p>Пример: обмен данными с модемом SIMCOM SIM7600E на пинах 21 (RX) и 22 (TX):</p>
<pre>  
  esp32#>uart 2
  esp32-uart2>up 21 22 115200
  esp32-uart2>write \ff\ff\CC\r\n    &larr; Отправка мусора: игнорируется модемом
  5 bytes sent 
  esp32-uart2>write ATI\r\n          &larr; Отправка команды ATI
  5 bytes sent
  esp32-uart2>read                   &larr; Чтение ответа
  ATI
  Manufacturer: SIMCOM INCORPORATED
  Model: SIMCOM_SIM7600E
  Revision: SIM7600M21-A_V1.1
  IMEI: 861005075537800
  +GCAP: +CGSM
 
  OK
  
  137 bytes read
</pre>
<p>Этот пример показывает, как настроить UART и отправить команду "ATI" устройству на UART2. Первая команда "write" посылает мусор, вторая — правильную команду. "read" получает ответ модема.</p>
  </td></tr>
</table>

<h2 id=tap><a href="#top">&#8686;</a>Прямое взаимодействие с устройством</h2>
<p>
Если у вас подключён GSM/LTE модем к UART ESP32, возможно, вы захотите отправлять AT-команды. Или у вас есть GPS-модуль и вы хотите наблюдать за его выводом NMEA. Или два ESP32 соединены через UART и оба работают под управлением ESPShell — и вы хотите выполнять удалённые команды.
</p>
<p>
Всё это возможно с помощью команды "<b>tap</b>", которая создаёт мост между пользовательским терминалом (например, UART0) и другим UART:
</p>
<table>
  <tr><th>Команда</th><th>Описание</th></tr>
  
  <tr><td><p>tap</p></td><td>
    <p><b>tap</b></p>
    <p>Устанавливает мост между терминалом пользователя и устройством на UART. Всё, что приходит с UART, отображается пользователю, а всё, что вводит пользователь, отправляется на UART. Особенно полезно при отладке модемов с AT-командами.</p>
    <p><b>Примечание:</b> монитор порта Arduino не поддерживает выход из режима tap по <kbd>Ctrl+C</kbd>.</p>

    <p>Пример: подключение к модему SIM7600E на пинах 18 (RX) и 19 (TX), отправка команды ATI и выход:</p>
<pre> 
  esp32#>uart 1
  esp32-uart1>up 18 19 115200
  esp32-uart1>tap
  Tapping to UART1, CTRL+C to exit
  ATI                               &larr; Отправлено пользователем
  Manufacturer: SIMCOM INCORPORATED &larr; Ответ модема
  Model: SIMCOM_SIM7600E
  Revision: SIM7600M21-A_V1.1
  IMEI: 861005075537800
  +GCAP: +CGSM

  OK

  Exit                              &larr; Нажат Ctrl+C
  esp32#>
</pre> 
  </td></tr>
</table>
</body>
</html>
