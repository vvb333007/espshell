<!DOCTYPE html>
<html lang="ru">
<head>
  <link rel="stylesheet" href="espshell.css">
  <title>ESPShell : Управление процессами : kill, suspend, resume и priority</title>
</head>
<body>
<p align=center><a href="index.ru.html"><img src="i/espshell_logo.jpg" alt="ESPShell для Arduino :: Содержание" width="70%" height="70%" /></a></p>
<h3 align=center><a href="Kill_Suspend_And_Resume.ru.html">[ На русском ]</a>&nbsp;&harr;&nbsp;<a href="Kill_Suspend_And_Resume.html">[ English ]</a></h3>
<p>
  <ul>
    <li><a href="#show">Просмотр информации о процессах</a></li>
    <li><a href="#process">Управление процессами</a></li>
    <li><a href="#suspend">Приостановка, возобновление и завершение</a></li>
    <li><a href="#prio">Приоритеты задач, установка приоритета</a></li>
  </ul>
</p>

<p id="show"><h2><a href="#top">&#8686;</a>ПРОСМОТР ИНФОРМАЦИИ О ПРОЦЕССАХ</h2></p>

<p>
Как и в других случаях, информация о задачах доступна с помощью команды "<b>show</b>":
<table>
  <tr><th>Команда</th><th>Описание и примеры</th></tr>
  <tr>
    <td><b>show tasks</b></td>
    <td>
      <p>Выводит список запущенных процессов, их ID, приоритет, имя и состояние:
<pre>
esp32#><b>show ta</b>
%  # |  Task  ID  |        Name      | Prio |   State
%----+------------+------------------+------+-----------
%   1| 0x3fca300c |         ESPShell |   5  | Running
%   2| 0x3fca7264 |            IDLE0 |   0  | Ready
%   3| 0x3fca5f64 |              pin |   0  | Ready
%   4| 0x3fca783c |            IDLE1 |   0  | Ready
%   5| 0x3fcaace8 |         loopTask |   1  | Waiting
%   6| 0x3fca85f4 |          Tmr Svc |   1  | Waiting
%   7| 0x3fca1790 |             ipc1 |  24  | Suspended
%   8| 0x3fca11f8 |             ipc0 |  24  | Suspended
%   9| 0x3fca5484 |        esp_timer |  22  | Suspended
%----+------------+------------------+------+-----------
% Total: 9 tasks
esp32#>
</pre>

      </p>
    </td>
  </tr>
</table>      

</p>

<p id="process"><h2><a href="#top">&#8686;</a>УПРАВЛЕНИЕ ПРОЦЕССАМИ</h2></p>

<p>
Управление процессами реализовано с помощью четырех команд: <b>suspend</b>, <b>resume</b>, <b>priority</b> и <b>kill</b>. Под процессами
имеются в виду задачи FreeRTOS: например, основная функция Arduino <i>loop()</i> обрабатывается отдельной задачей FreeRTOS с именем "loop",
то есть "<i>loop()</i>"  - это процесс (в списке задач он находится под именем "loopTask").
</p>

<p>
Доступ к задачам и управление ими осуществляется по их TASK_ID (шестнадцатеричное число, например "0x3fca370c") или по имени,
за исключением основной задачи loop() Arduino: выполнение основного скетча можно контролировать, опустив параметр TASK_ID
в команде. То есть, чтобы приостановить скетч, вместо "suspend 0x12345678" можно использовать
команду "suspend" без аргументов.
</p>
<p>
ВАЖНО: Несколько процессов могут иметь полностью одинаковые имена. Такое происходит, например, когда запускается несколько фоновых команд, скажем, "pin":
<pre>
  esp32#>pin 2 low delay 100 high delay 100 loop infinite &
  esp32#>pin 4 low delay 200 high delay 200 loop infinite &
</pre>
В списке процессов будет два процесса с одинаковым именем "pin". В таком случае следует использовать TASK_ID, а не имя. Если же использовать имя задачи, то операция будет производится над первой задачей с таким именем в списке.
Порядковый номер задачи в списке постоянно меняется, на него нельзя полагаться.
</p>

<p>
Хорошо, но где взять эти task id и имена?
</p>

<p>
Например, можно воспользоваться командой "<b>show tasks</b>":
<pre>
esp32#>show tasks
%  # |  Task  ID  |        Name      | Prio |   State
%----+------------+------------------+------+-----------
%   1| 0x3fca783c |            IDLE1 |   0  | Ready
%   2| 0x3fca7264 |            IDLE0 |   0  | Ready
%   3| 0x3fca300c |         ESPShell |   0  | Running
%   4| 0x3fca5f64 |              pin |   0  | Ready
%   5| 0x3fcaace8 |         loopTask |   1  | Waiting
%   6| 0x3fca1790 |             ipc1 |  24  | Suspended
%   7| 0x3fca11f8 |             ipc0 |  24  | Suspended
%   8| 0x3fca5484 |        esp_timer |  22  | Suspended
%   9| 0x3fca85f4 |          Tmr Svc |   1  | Waiting
%----+------------+------------------+------+-----------
% Total: 9 tasks
esp32#>
</pre>
</p>

<p>Так же,
 каждая команда ESPShell, которая запускается как процесс, всегда выводит свой TASK_ID. Допустим, мы запускаем команду "<b>pin 2 delay 1000</b>" в фоновом режиме:
<pre>
esp32#>pin 2 delay 1000 &
% Background task started
% Copy/paste "kill 0x3ffb91dc" to abort
esp32#>
</pre>
Эта простая команда ничего не делает, кроме как ждёт 1000 мс. После запуска она выводит свой task id и команду, которую можно скопировать и выполнить: "kill 0x3ffb91dc".
</p>

<p>
Другим источником TASK_ID является команда "<b><a href="Pulse_Counter.ru.html#show">show counters</a></b>"
</p>

<p id="suspend"><h2><a href="#top">&#8686;</a>ПРИОСТАНОВКА, ВОЗОБНОВЛЕНИЕ И ЗАВЕРШЕНИЕ</h2></p>

<table>
  <tr><th>Команда</th><th>Описание и примеры</th></tr>

  <tr>
    <td><b>suspend</b></td>
    <td>
      <p>Приостанавливает выполнение скетча: приостанавливает <b>loop()</b> Arduino. Задачи, которые были запущены из <b>loop()</b> и <b>setup()</b>,
  <b>не приостанавливаются</b> этой командой. Приостановка задачи вместе со всеми её дочерними задачами  - запланированная, но пока не реализованная возможность.
 Комбинация клавиш Ctrl+C является горячей клавишей для команды "<b>suspend</b>"</p>
    </td>
  </tr>

  <tr>
    <td><b>suspend</b> <i>TASK_ID</i></td>
    <td>
      <p><b>suspend</b> <i>TASK_ID</i></p>
      <p>Приостанавливает произвольную задачу, если известен её идентификатор. Команда требует один
  аргумент  - идентификатор задачи (в шестнадцатеричном формате)</p>
    </td>
  </tr>

  <tr>
    <td><b>resume</b></td>
    <td>
      <p>Возобновляет выполнение скетча</p>
    </td>
  </tr>

  <tr>
    <td><b>resume</b> <i>TASK_ID</i></td>
    <td>
      <p><b>resume</b> <i>TASK_ID</i></p>
      <p>Возобновляет произвольную задачу, если известен её идентификатор. Команда требует один
  аргумент  - идентификатор задачи (в шестнадцатеричном формате)</p>
    </td>
  </tr>

</table>

<p>
Чтобы остановить задачу ESPShell (ESPShell <a href="Basics.ru.html#background">использует задачи</a> для запуска фоновых команд) или произвольную задачу FreeRTOS, можно воспользоваться
командой "<b>kill</b>":
</p>

<table>
  <tr><th>Команда</th><th>Описание и примеры</th></tr>

  <tr>
    <td><b>kill</b> <i>TASK_ID</i></td>
    <td><p>    "<b>kill</b> [-TERM | -15 | -KILL | -9] <i>TASK_ID</i>"</p>
<p>
Останавливает выполнение задачи с TASK_ID. Этот идентификатор либо выводится при запуске фоновой команды,
либо может быть произвольным идентификатором FreeRTOS-задачи. Если в конце команды используется символ "&",
то ESPShell выполняет такую команду в фоновом режиме, создавая новую задачу:
</p>
<p>
<pre>
      esp32#>pin 2 delay 999 &
      % Background task started
      % Copy/paste "kill 0x3fca370c" command to stop execution  &larr; обратите внимание на TASK_ID
      esp32#>
</pre>
</p>

<p>
В простейшем случае, когда используется только один параметр (TASK_ID), команда <i>отправляет уведомление</i>
задаче, которую нужно завершить, чтобы она могла завершиться корректно.
</p>
<p>
Команда старается имитировать классическую команду "kill" из Linux и принимает дополнительный параметр  -
<i>сигнал</i>, который нужно отправить: <b>-9</b> или <b>-KILL</b> означает принудительное завершение задачи. Уведомление не отправляется,
вместо этого задача приостанавливается и удаляется с помощью FreeRTOS API vTaskDelete(). При этом ресурсы, занятые задачей, не освобождаются.
Завершение задачи, которая удерживает мьютекс, может привести к зависаниям.
</p><p>
Все задачи, создаваемые ESPShell, должны завершаться таким образом  - без указания дополнительных параметров.
Однако есть примеры команд ESPShell, которые можно завершить только с помощью "kill -9", эти особые случаи описаны
<a href="GPIO.ru.html">в описании</a> команды "pin".
</p><p>
Опция <b>-15</b>, <b>-TERM</b> или её отсутствие означает "корректное завершение": задача не удаляется, а получает возможность завершиться самостоятельно и освободить все используемые ресурсы (если таковые имеются).
</p><p>
Опция <b>-9</b> или <b>-KILL</b> приводит к приостановке задачи с её последующим удалением через API FreeRTOS <i>vTaskDelete()</i>.
Эта опция эквивалентна команде Linux "kill -9", но в отличие от неё, ESPShell не освобождает ресурсы, которые могли быть выделены задачей.
</p>
    </td>
  </tr>

</table>

<p id="prio"><h2><a href="#top">&#8686;</a>ПРИОРИТЕТЫ ПРОЦЕССОВ, УСТАНОВКА ПРИОРИТЕТА</h2></p>

<p>
В ESP32 процессами (задачами) управляет модифицированная FreeRTOS, которая является одним из компонентов ESP-IDF.
</p>
<p>
Задачи, находящиеся под управлением FreeRTOS, получают управление в соответствии с присвоенными им <i>приоритетами</i>. Приоритет может принимать значение от 0 до 24: чем больше число, тем выше приоритет.
</p><p>
С максимальным приоритетом запускаются системные задачи межпроцессорного взаимодействия — <b>ipc0</b> и <b>ipc1</b>. Высокий приоритет присвоен компонентам Bluetooth и Wi-Fi. Минимальный приоритет имеют так называемые idle-процессы: <b>IDLE0</b> и <b>IDLE1</b>.
</p><p>
По умолчанию ESPShell запускается с приоритетом 0, что соответствует уровню системных idle-процессов. Все вспомогательные задачи, создаваемые шеллом, также запускаются с этим приоритетом. Приоритет задач, инициируемых шеллом (например, фоновых команд), наследуется от него.
</p><p>
Приоритет можно изменить с помощью команды <b>priority NUM [TASK_ID]</b>. Если второй параметр (ID задачи) опущен, новое значение устанавливается для самого шелла. Если указан — приоритет будет изменён у соответствующей задачи.
</p>

<p>
Пример: посмотреть, какой приоритет установлен у шелла, поменять его на 5
<pre>
esp32#><b>sh ta</b>
%  # |  Task  ID  |        Name      | Prio |   State
%----+------------+------------------+------+-----------
%   1| 0x3fca5f64 |              pin |   0  | Ready
%   2| 0x3fca7264 |            IDLE0 |   0  | Ready
%   3| 0x3fca300c |         <b>ESPShell</b> |   <b>0</b>  | Running
%   4| 0x3fca783c |            IDLE1 |   0  | Ready
%   5| 0x3fcaace8 |         loopTask |   1  | Waiting
%   6| 0x3fca11f8 |             ipc0 |  24  | Suspended
%   7| 0x3fca5484 |        esp_timer |  22  | Suspended
%   8| 0x3fca85f4 |          Tmr Svc |   1  | Waiting
%   9| 0x3fca1790 |             ipc1 |  24  | Suspended
%----+------------+------------------+------+-----------
% Total: 9 tasks
esp32#><b>prio 5</b>
esp32#>sh ta
%  # |  Task  ID  |        Name      | Prio |   State
%----+------------+------------------+------+-----------
%   1| 0x3fca300c |         <b>ESPShell</b> |   <b>5</b>  | Running
%   2| 0x3fca7264 |            IDLE0 |   0  | Ready
%   3| 0x3fca783c |            IDLE1 |   0  | Ready
%   4| 0x3fca5f64 |              pin |   0  | Ready
%   5| 0x3fcaace8 |         loopTask |   1  | Waiting
%   6| 0x3fca5484 |        esp_timer |  22  | Suspended
%   7| 0x3fca85f4 |          Tmr Svc |   1  | Waiting
</pre>
</p>
<p>
<b>Примечание о приоритетах задач:</b><br>
Команда шелла <b>pin 2 low high loop inf</b> генерирует прямоугольный сигнал с частотой 150 кГц при запуске с приоритетом IDLE. Однако при повышении приоритета до 2 частота увеличивается до 560 кГц.
Это происходит потому, что команда <b>pin</b> никогда не уступает управление процессору, не позволяя задачам с более низким приоритетом выполняться.
</p>
</body>
</html>
