<!DOCTYPE html>
<html lang="en">
<head>
  <title>Aliases and Events : creating and executing shell scripts</title>
  <link rel="stylesheet" href="espshell.css">
  <meta charset="UTF-8">
</head>
<body>
<p align=center><a href="index.html"><img src="i/espshell_logo.jpg" alt="ESPShell for Arduino :: Basic concepts and command index" width="70%" height="70%" /></a></p>
<h3 align=center><a href="Aliases_And_Events.ru.html">[ На русском ]</a>&nbsp;&harr;&nbsp;<a href="Aliases_And_Events.html">[ English ]</a></h3>
<p>
  <ul>
    <li><a href="#wit">What is this? An example</a></li>
    <li><a href="#cee">Aliases : creating, editing, executing</a></li>
    <li><a href="#show_alias">Displaying information on aliases</a></li>
    <li><a href="#ifcond">Conditions and events: command "<b>if</b>"</a></li>
    <li><a href="#every">Periodic events: command "<b>every</b>"</a></li>
    <li><a href="#show_ifs">Displaying information on events</a></li>
 </ul>
</p>

<p><h2 id=wit><a href="#top">&#8686;</a>WHAT IS THIS:</h2></p>

<p>
Aliases, or "command aliases", are a way to execute several shell commands at once, like a shell script—either explicitly using the "<b>exec</b>" command or indirectly as part of the "<b>if</b>" command. 
Aliases have <i>names</i> and are referred to by those names. You can think of them as <i>named containers</i> filled with commands—similar to "<b>.sh</b>" or "<b>.bat</b>" files, but stored in RAM.
</p>

<p>
Let's look at a simple home automation task: water pump control. This will give you a general understanding of the alias and event system. A full command list and additional details are provided later in the document.
</p>

<p>
You have a water tank with two sensors: GPIO2 for "Water Too Low" and GPIO4 for "Water Too High".
</p>
<p>
You have a water tank, with two sensors, GPIO2, for "Water Too Low" and another (GPIO4) is "Water Too High". 
</p>

<p>
<pre>                        
                             water in
                           <=========+
                      |       |      |
  GPIO4 <-------------#       |      |
 "Overflow" sens      |~~~~~~~|      |
                      | .  o  |      |
                      |  . .  |      |
  GPIO2 <-------------# water |     ###<------------- GPIO20, "Start"
 "Too low!" sens      | o .   |     # # WATER PUMP
                      |__   __|     ###<------------- GPIO21, "Drive"
                         \ /
                         | |
                      water out

</pre>
</p>

<p align=center>
<img src="i/watertank.jpg" width="70%" height="70%" alt="Water Tank Scheme" /><br>
<i>Fig. 1: Water Tank and Water Pump scheme</i>
</p>

<p>
Sensors consist of two wires that are shorted by water in the tank. A HIGH level appears at the "sensor" output when water touches it, and it goes LOW when the water level drops below the sensor.
</p>

<p>
The water pump can be turned ON and OFF by toggling GPIO20 HIGH for 3 seconds, then toggling GPIO21 HIGH. GPIO20 is used to "start" the motor with a higher current, while GPIO21 allows the pump to run normally.
</p>

<p>
When the water reaches the upper sensor, GPIO4 voltage goes from LOW to HIGH. When the water drops below the lower sensor, GPIO2 voltage falls from HIGH to LOW.
</p>

<p><b>How do you implement automatic pump control using shell commands?</b></p>

<p>
First, let's create "motor_on" and "motor_off" aliases to control the motor:
<pre>
  esp32#>alias motor_on
  esp32-alias>
</pre>

The "<b>alias motor_on</b>" command creates a new alias named "motor_on". The shell enters alias editing mode, where <b><i>any</i></b> command you type is recorded as part of the alias:
</p>

<pre>
esp32#>alias motor_on
esp32-alias>pin 4 high delay 3000 low
esp32-alias>pin 4 low 2 high
esp32-alias>Hello World!
</pre>

<p>
<b>NOTE:</b> To exit alias editing mode, use the <b>"quit"</b> command instead of "<b>exit</b>". This is because "exit" may be a valid command within the alias itself.
</p>

<p>
You can list the alias contents at any time using the "<b>list</b>" command:
<pre>
  esp32-alias>list
  % Alias "motor_on":
  % 1: pin 4 high delay 3000 low
  % 2: pin 2 high 4 low
  % 3: Hello World!
  % --- END ---
</pre>

The numbers are <i>line numbers</i>, which can be used with the "<b>delete</b>" command to remove specific lines. For example, let's delete the "Hello World!" line:
<pre>
  esp32-alias><b>del 3</b>
  esp32-alias><b>list</b>
  % Alias "motor_on":
  % 1: pin 4 high delay 3000 low
  % 2: pin 4 low 2 high
  % --- END ---
</pre>
<b>NOTE:</b> "delete" without arguments removes the last command. "delete all" clears the entire alias.
</p>

<p>
Now let’s define the "<b>motor_off</b>" alias:
<pre>
  esp32#>alias motor_off
  esp32-alias>pin 2 low 4 low
  esp32-alias>quit
  esp32#>
</pre>

You’ve now created two aliases filled with commands, ready to be executed using the "<b>exec</b>" command:
<pre>
  esp32#>exec motor_on
  esp32#>exec motor_off
</pre>
</p>

<p>
Recall that GPIO2 (lower sensor) and GPIO4 (upper sensor) indicate water levels. GPIO4 voltage <i>rises</i> when the water reaches the upper sensor; GPIO2 voltage <i>falls</i> when the water drops below the lower sensor.

For such events (signal rising/falling edges), the <b><a href="#if">if</a></b> command is used:
<pre>
  esp32#>if falling 2 exec motor_on
  esp32#>if rising 4 exec motor_off
</pre>

Entered conditions (if) start working immediately (unless <a href="#delay">otherwise specified</a>), monitoring the signal level
on the sensors and turning the motor on/off at the appropriate time. Of course, this is a very simplified scheme. In reality, you will need to specify
the <i>maximum allowed frequency</i> for event triggering.
</p>

<p>
Ok, done with short example, now the details:
</p>

<h2 id=cee><a href="#top">&#8686;</a>ALIASES: CREATING, EDITING, EXECUTING</h2>

<table>
<tr><td><b>Command</b></td><td><b>Description and examples</b></td></tr>

<tr>
<td><b>alias <i>NAME</i></b></td>
<td>
<p>
1. Creates an empty alias <i>NAME</i> and enters alias editing mode ("quit" to exit)<br />
2. If the alias already exists, simply enters alias editing mode
</p>

<p>
While in editing mode, you can list the alias content (with "<b>list</b>"), delete lines (with "<b>delete</b>"), or exit editing mode (with "<b>quit</b>"). The "<b>exit</b>" command is allowed within an alias, so the shell uses "<b>quit</b>" to leave editing mode.
</p>

<p>
Any other command entered is recorded as part of the alias.
</p>

<p align="center">
Example:
<pre>
esp32#>alias motor_off
% Entering alias editing mode. "quit" to return
esp32-alias>pin 2 low 4 low
esp32-alias>echo Setting pins 2 and 4 low
esp32-alias>quit
esp32#>
</pre>
</p>
</td></tr>

<tr>
<td><b>show alias <i>[NAME]</i></b></td>
<td>
<p>
<b>show alias</b> — shows all defined aliases<br />
<b>show alias <i>NAME</i></b> — shows the content of alias <i>NAME</i>
</p>

<p>
Example: show all aliases
<pre>
esp32#>show alias
% List of defined aliases:
% 1. "motor_off"
% 2. "motor_on"
% 3. "fail_2"
% 4. "test", empty
esp32#>
</pre>

Example: show alias <b>motor_on</b>
<pre>
esp32#>sh al motor_on
% Alias "motor_on":
% 1: echo silent
% 2: uart 0
% 3: write Motor spin-up, wait...
% 4: pin 20 high delay 3000
% 5: write Done.\n
% 6: pin 21 high 20 low
% 7: write Pumping, wait...
% 8: exit
% 9: echo on
% --- END ---
</pre>
</p>
</td></tr>

<tr>
<td><b>exec <i>NAME</i> [NAME1 NAME2 ... NAMEn]</b></td>
<td>
<p>Executes alias/aliases <i>NAME</i>, NAME1, NAME2, ..., in sequence.</p>

<p>
Example: execute alias <b>motor_on</b>
<pre>
esp32#>exec motor_on
Motor spin-up, wait...Done.
Pumping, wait...
</pre>
</p>
</td></tr>
</table>
</p>


<h2 id=ifcond><a href="#top">&#8686;</a>CONDITIONS, EVENTS, AND ACTIONS: THE "IF" COMMAND</h2>
<p>
The <b>if</b> command, as illustrated in the water tank example at the beginning of this document, is designed
to respond to <i>events</i> on pins. There are two such events — a voltage rise (transition from logical 0 to logical 1, "rising") and
a voltage drop ("1" &rarr; "0", "falling"). The registration of these events is handled by hardware — the processor generates interrupts when such events occur.
</p>
<p>
The simplest condition reacts to a voltage falling on GPIO2 by triggering some reaction/action:
<pre>
  esp32#>if falling 2 exec My_Alias
</pre>
The initial condition that triggers the shell (rising or falling) can be extended with <i>additional conditions</i>.
Let’s add extra checks to the above example so that it only triggers if GPIO4 is in state "0" and GPIO1 is in state "1":
<pre>
  esp32#>if falling 2 <b>low 4 high 0</b> exec My_Alias
</pre>
These additional conditions are checked at the moment the main event occurs, and if they do not match the actual pin states, the event is discarded,
and the dropped events counter is increased (see the "show if" command, "Drops" column).
</p>

<p>
Is it possible to omit the main (rising/falling) event entirely, and what would that mean?
</p>
<p>
Yes, it is possible. For example, you can write the following condition:
<pre>
  esp32#>if low 2 exec My_Alias
</pre>
What will happen in this case? ESPShell will poll the state of pin #2 <i>once per second</i>, and if the condition matches, it will execute
the My_Alias alias. This type of condition is called a <i>periodic</i> or <i>polling</i> condition. The polling frequency can be set by using the <b>poll</b> keyword:
<pre>
  esp32#>if low 2 poll 10000 exec My_Alias &larr; poll every 10,000 milliseconds.
</pre>
The <b>poll</b> keyword only makes sense for periodic conditions. If the condition is rising or falling, the poll parameter will be ignored,
and a corresponding warning will be displayed.
</p>

<p>
Can you limit the number of times a condition is triggered? Yes, you can use the <b>max-exec</b> keyword for that.
The example below limits the number of triggers to five and also adds two more pin checks:
<pre>
  esp32#>if low 2 low 4 high 0 poll 10000 max-exec 5 exec My_Alias
</pre>
What happens after the condition triggers five times? The condition will still be evaluated but will no longer execute the alias.
Instead, the dropped events counter will increase, which you can see in the output of the "<b>show if</b>" command (in the Drops column):
</p>
<p align=center><img src="i/show_ifs_drops_max-exec.jpg" alt="show ifs command output" width="70%" height="70%"><br><i>Fig. 2: "show ifs" output, max-exec limit reached</i></p>
<p>Note the red color and an exclamation mark at <i>Hits</i> counter: it is an indication, that condition is reached its <b>max-exec</b> limit. Such entries can be reset to its initial state with command <b>if clear</b></p>
<p>
When defining rising/falling conditions, remember that these are checked inside an interrupt. If the interrupt rate is not limited,
you risk being flooded with events and triggering the My_Alias command excessively. Simple signal bounce can generate
a thousand interrupts per second, and a floating ESP32 pin or other factors could cause the system to hang.
</p>
<p>
To prevent this, use the <b>rate-limit</b> keyword (or simply <b>rate</b> — keywords can be abbreviated).
This keyword takes a single parameter — the minimum interval in milliseconds between condition triggers. For example, specifying
<b>rate-limit 500</b> ensures that the condition will not trigger more than once every half second (500 milliseconds). Events occurring more frequently than the set limit will be discarded, and the dropped events counter will increase:
</p>
<p align=center><img src="i/show_ifs.jpg" alt="show ifs command output" width="70%" height="70%"><br><i>Fig. 3: "show ifs" output, rate-limit</i></p>

<table>
<tr><td><b>Command</b></td><td><b>Description and examples</b></td></tr>

<tr><td><p><b>if</b></p></td><td>
<p>if <b>rising</b>|<b>falling</b> <i>PIN1</i> [<b>low</b>|<b>high</b> <i>PINn</i>]* [<b>max-exec</b> <i>NUM</i>] [<b>rate-limit</b> <i>MILLIS</i>] <b>exec</b> <i>ALIAS_NAME</i> </p>
<p>if <b>low</b>|<b>high</b> <i>PIN1</i> [<b>low</b>|<b>high</b> <i>PINn</i>]* [<b>max-exec</b> <i>NUM</i>] [<b>poll</b> <i>MILLIS</i>] <b>exec</b> <i>ALIAS_NAME</i> </p>
<p>if <b>clear</b>|<b>delete</b> [<b>gpio</b>] <i>NUM</i></p>
<p>if <b>clear</b>|<b>delete</b> <b>all</b></p>
TBD:..
</td></tr>
</table>

<p>
You can also write a condition without any condition at all — this will be a simple periodic event that executes unconditionally:
<pre>
  esp32#>if poll 10000 exec My_Alias
</pre>
Although this syntax works, it is not the proper way to define a periodic event.
For periodic events, there is a more convenient form: the <b>every</b> command.
</p>

<h2 id=every><a href="#top">&#8686;</a>PERIODIC EVENTS</h2>
<p>
To set up periodic execution, you can use the <b>every</b> command, which takes (in addition to the alias to execute) the <i>interval</i> between executions and an optional <i>initial delay</i>.
</p>
<p>
If we define a simple periodic condition like this:
<pre>
  esp32#>every 1 day exec My_Alias
</pre>
the <i>first execution</i> will happen immediately, right after pressing &lt;Enter&gt;, and subsequent executions will occur every 24 hours.
But what if we don’t want the first execution to happen immediately? We can use the <b>delay</b> keyword:
<pre>
  esp32#>every 1 day delay 1 hour exec My_Alias
</pre>
In this version, the first execution will happen in one hour, and all subsequent executions will occur every 24 hours.
</p>
<p>
<table>
<tr><td><b>Command</b></td><td><b>Description and examples</b></td></tr>

<tr><td><p><b>every</b></p></td><td>
<p>every NUM milliseconds|seconds|minutes|hours|days [<b>max-exec</b> <i>NUM</i>] [<b>delay</b> <i>MILLIS</i>] <b>exec</b> <i>ALIAS_NAME</i> </p>
<p>every <b>clear</b> <i>NUM</i>|<b>all</b></p>
<p>every <b>delete</b> <i>NUM</i>|<b>all</b></p>

TBD:..
</td></tr>
</table>
</p>


</body>
</html>
