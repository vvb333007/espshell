<!DOCTYPE html>
<html lang="en">
<head>
  <title>Aliases and Events : creating and executing shell scripts</title>
  <link rel="stylesheet" href="espshell.css">
  <meta charset="UTF-8">
</head>
<body>
<p align=center><a href="index.html"><img src="i/espshell_logo.jpg" alt="ESPShell for Arduino :: Basic concepts and command index" width="70%" height="70%" /></a></p>
<h3 align=center><a href="Aliases_And_Events.ru.html">[ На русском ]</a>&nbsp;&harr;&nbsp;<a href="Aliases_And_Events.html">[ English ]</a></h3>
<p>
  <ul>
    <li><a href="#wit">Что это такое, вообще? Короткий пример.</a></li>
    <li><a href="#cee">Алиасы : создание, редактирование и исполнение</a></li>
    <li><a href="#show">Отображение информации об алиасах</a></li>
    <li><a href="#ifcond">Условия, события и действия: команда "<b>if</b>"</a></li>
    <li><a href="#ifcond_show">Переодические действия: команда "<b>every</b>"</a></li>
 </ul>
</p>

<p><h2 id=wit><a href="#top">&#8686;</a>ЧТО ЭТО ТАКОЕ:</h2></p>

<p>
Алиасы, или «командные алиасы» — это способ выполнения сразу нескольких команд оболочки, как в shell-скрипте: либо явно, с помощью команды <b>exec</b>, либо неявно — как часть команды <b>if</b>.  
Алиасы имеют <i>имена</i> и вызываются по этим именам. Их можно представить как <i>именованные контейнеры</i> с командами — аналог файлов "<b>.sh</b>" или "<b>.bat</b>", только хранящихся в оперативной памяти.
</p>

<p>
Рассмотрим простую задачу автоматизации дома: управление водяным насосом. Она поможет вам в общих чертах понять систему алиасов и событий. Подробный список команд приведён в конце документа.
</p>

<p>
У нас есть ёмкость с водой и два датчика: GPIO2 для сигнала «Мало воды» и GPIO4 — «Слишком много воды».
</p>

<p>
Датчики состоят из двух проводов, которые замыкаются водой в баке. Когда вода касается датчика, на его выходе появляется высокий уровень (HIGH), а когда уровень воды падает ниже датчика — он переходит в низкий (LOW).
</p>

<p>
Водяной насос включается и выключается последовательным управлением: сначала установить высокий уровень на GPIO20 на 3 секунды, затем — на GPIO21. GPIO20 используется для «старта» двигателя с повышенным током, а GPIO21 — для нормального режима работы.
</p>

<p>
Когда вода достигает верхнего датчика, напряжение на GPIO4 меняется с LOW на HIGH. Когда вода опускается ниже нижнего датчика — напряжение на GPIO2 падает с HIGH до LOW.
</p>

<p><b>Как реализовать автоматическое управление насосом с помощью команд оболочки?</b></p>

<p>
Сначала создадим алиасы "motor_on" и "motor_off" для управления насосом:
<pre>
  esp32#>alias motor_on
  esp32-alias>
</pre>

Команда "<b>alias motor_on</b>" создаёт новый алиас с именем "motor_on" и переводит оболочку в режим редактирования алиаса. В этом режиме <b><i>любая</i></b> введённая команда добавляется в алиас:
</p>

<pre>
esp32#>alias motor_on
esp32-alias>pin 4 high delay 3000 low
esp32-alias>pin 4 low 2 high
esp32-alias>Hello World!
</pre>

<p>
<b>ПРИМЕЧАНИЕ:</b> Чтобы выйти из режима редактирования, используется команда <b>"quit"</b>, а не "<b>exit</b>", поскольку "exit" может быть частью самого алиаса.
</p>

<p>
В любой момент можно просмотреть содержимое алиаса командой "<b>list</b>":
<pre>
  esp32-alias>list
  % Alias "motor_on":
  % 1: pin 4 high delay 3000 low
  % 2: pin 2 high 4 low
  % 3: Hello World!
  % --- END ---
</pre>

Числа 1, 2, 3 — это <i>номера строк</i>. Их можно использовать с командой "<b>delete</b>" для удаления конкретной строки. Удалим, например, "Hello World!":
<pre>
  esp32-alias><b>del 3</b>
  esp32-alias><b>list</b>
  % Alias "motor_on":
  % 1: pin 4 high delay 3000 low
  % 2: pin 4 low 2 high
  % --- END ---
</pre>
<b>ПРИМЕЧАНИЕ:</b> команда "delete" без аргументов удаляет последнюю строку. "delete all" — очищает весь алиас.
</p>

<p>
Теперь создадим алиас "<b>motor_off</b>":
<pre>
  esp32#>alias motor_off
  esp32-alias>pin 2 low 4 low
  esp32-alias>quit
  esp32#>
</pre>

Теперь у нас есть два алиаса с командами. Их можно выполнять с помощью команды "<b>exec</b>":
<pre>
  esp32#>exec motor_on
  esp32#>exec motor_off
</pre>
</p>

<p>
Напомним: GPIO2 — нижний датчик, GPIO4 — верхний. Когда вода доходит до верхнего, напряжение на GPIO4 <i>повышается</i>. Когда опускается ниже нижнего — напряжение на GPIO2 <i>падает</i>.

Для таких событий (рост/падение сигнала) используется команда <b>if</b>:
<pre>
  esp32#>if falling 2 exec motor_on
  esp32#>if rising 4 exec motor_off
</pre>

Это был краткий пример работы системы алиасов и событий. Далее — подробности.
</p>

---

<h2 id=cee><a href="#top">&#8686;</a>АЛИАСЫ: СОЗДАНИЕ, РЕДАКТИРОВАНИЕ, ВЫПОЛНЕНИЕ</h2>

<table>
<tr><td><b>Команда</b></td><td><b>Описание и примеры</b></td></tr>

<tr>
<td><b>alias <i>ИМЯ</i></b></td>
<td>
<p>
1. Создаёт пустой алиас с именем <i>ИМЯ</i> и входит в режим редактирования ("quit" для выхода)<br />
2. Если алиас уже существует — просто входит в режим редактирования
</p>

<p>
В режиме редактирования можно просматривать содержимое ("<b>list</b>"), удалять строки ("<b>delete</b>") или выйти командой "<b>quit</b>". Поскольку "exit" может быть частью алиаса, используется специальная команда "quit".
</p>

<p>
Все остальные команды просто добавляются в алиас как есть.
</p>

<p align="center">
Пример:
<pre>
esp32#>alias motor_off
% Вход в режим редактирования алиаса. Для выхода — "quit"
esp32-alias>pin 2 low 4 low
esp32-alias>echo Setting pins 2 and 4 low
esp32-alias>quit
esp32#>
</pre>
</p>
</td></tr>

<tr>
<td><b>show alias <i>[ИМЯ]</i></b></td>
<td>
<p>
<b>show alias</b> — выводит список всех определённых алиасов<br />
<b>show alias <i>ИМЯ</i></b> — показывает содержимое указанного алиаса
</p>

<p>
Пример: список алиасов
<pre>
esp32#>show alias
% Список алиасов:
% 1. "motor_off"
% 2. "motor_on"
% 3. "fail_2"
% 4. "test", пустой
esp32#>
</pre>

Пример: просмотр алиаса <b>motor_on</b>
<pre>
esp32#>sh al motor_on
% Alias "motor_on":
% 1: echo silent
% 2: uart 0
% 3: write Motor spin-up, wait...
% 4: pin 20 high delay 3000
% 5: write Done.\n
% 6: pin 21 high 20 low
% 7: write Pumping, wait...
% 8: exit
% 9: echo on
% --- END ---
</pre>
</p>
</td></tr>

<tr>
<td><b>exec <i>ИМЯ</i> [ИМЯ1 ИМЯ2 ... ИМЯn]</b></td>
<td>
<p>Выполняет указанный алиас (или список алиасов) поочерёдно.</p>

<p>
Пример: выполнение алиаса <b>motor_on</b>
<pre>
esp32#>exec motor_on
Motor spin-up, wait...Done.
Pumping, wait...
</pre>
</p>
</td></tr>
</table>



</body>
</html>
