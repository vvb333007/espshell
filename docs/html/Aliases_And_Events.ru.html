<!DOCTYPE html>
<html lang="en">
<head>
  <title>Aliases and Events : creating and executing shell scripts</title>
  <link rel="stylesheet" href="espshell.css">
  <meta charset="UTF-8">
</head>
<body>
<p align=center><a href="index.html"><img src="i/espshell_logo.jpg" alt="ESPShell for Arduino :: Basic concepts and command index" width="70%" height="70%" /></a></p>
<h3 align=center><a href="Aliases_And_Events.ru.html">[ На русском ]</a>&nbsp;&harr;&nbsp;<a href="Aliases_And_Events.html">[ English ]</a></h3>
<p>
  <ul>
    <li><a href="#wit">Что это такое, вообще? Короткий пример.</a></li>
    <li><a href="#cee">Алиасы : создание, редактирование и исполнение</a></li>
    <li><a href="#show">Отображение информации об алиасах</a></li>
    <li><a href="#ifcond">Условия, события и действия: команда "<b>if</b>"</a></li>
    <li><a href="#every">Переодические действия: команда "<b>every</b>"</a></li>
    <li><a href="#ifcond_show">Отображение информации об условиях IF/EVERY</a></li>
 </ul>
</p>

<p><h2 id=wit><a href="#top">&#8686;</a>ЧТО ЭТО ТАКОЕ:</h2></p>

<p>
Алиасы, или «командные алиасы» — это способ выполнения сразу нескольких команд оболочки, как в shell-скрипте: либо явно, с помощью команды <b>exec</b>, либо неявно — как часть команды <b>if</b>.  
Алиасы имеют <i>имена</i> и вызываются по этим именам. Их можно представить как <i>именованные контейнеры</i> с командами — аналог файлов "<b>.sh</b>" или "<b>.bat</b>", только хранящихся в оперативной памяти.
</p>

<p>
Рассмотрим простую задачу автоматизации дома: управление водяным насосом. Она поможет вам в общих чертах понять систему алиасов и событий. Подробный список команд приведён в конце документа.
</p>

<p>
У нас есть ёмкость с водой и два датчика: GPIO2 для сигнала «Мало воды» и GPIO4 — «Слишком много воды».
</p>

<p>
<pre>                        
                             Залив
                           <=========+
                      |       |      |
  GPIO4 <-------------#       |      |
 "Слишком" sens       |~~~~~~~|      |
                      | .  o  |      |
                      |  . .  |      |
  GPIO2 <-------------# вода  |     ###<------------- GPIO20, "Start"
 "Мало" sens          | o .   |     #@# 
                      |__   __|     ###<------------- GPIO21, "Drive"
                         \ /     Водяной насосик,
                         | |     с контроллером
                        Слив

</pre>
</p>

<p align=center>
<img src="i/watertank.jpg" width="70%" height="70%" alt="Water Tank Scheme" /><br>
<i>Рис. 1: Схема подключения и общая идея</i>
</p>

<p>
Датчики состоят из двух проводов, которые замыкаются водой в баке. Когда вода касается датчика, на его выходе появляется высокий уровень (HIGH), а когда уровень воды падает ниже датчика — он переходит в низкий (LOW).
</p>

<p>
Водяной насос включается и выключается последовательным управлением: сначала установить высокий уровень на GPIO20 на 3 секунды, затем — на GPIO21. GPIO20 используется для «старта» двигателя с повышенным током, а GPIO21 — для нормального режима работы.
</p>

<p>
Когда вода достигает верхнего датчика, напряжение на GPIO4 меняется с LOW на HIGH. Когда вода опускается ниже нижнего датчика — напряжение на GPIO2 падает с HIGH до LOW.
</p>

<p><b>Как реализовать автоматическое управление насосом с помощью команд оболочки?</b></p>

<p>
Сначала создадим алиасы "motor_on" и "motor_off" для управления насосом:
<pre>
  esp32#>alias motor_on
  esp32-alias>
</pre>

Команда "<b>alias motor_on</b>" создаёт новый алиас с именем "motor_on" и переводит оболочку в режим редактирования алиаса. В этом режиме <b><i>любая</i></b> введённая команда добавляется в алиас:
</p>

<pre>
esp32#>alias motor_on
esp32-alias>pin 4 high delay 3000 low
esp32-alias>pin 4 low 2 high
esp32-alias>Hello World!
</pre>

<p>
<b>ПРИМЕЧАНИЕ:</b> Чтобы выйти из режима редактирования, используется команда <b>"quit"</b>, а не "<b>exit</b>", поскольку "exit" может быть частью самого алиаса.
</p>

<p>
В любой момент можно просмотреть содержимое алиаса командой "<b>list</b>":
<pre>
  esp32-alias>list
  % Alias "motor_on":
  % 1: pin 4 high delay 3000 low
  % 2: pin 2 high 4 low
  % 3: Hello World!
  % --- END ---
</pre>

Числа 1, 2, 3 — это <i>номера строк</i>. Их можно использовать с командой "<b>delete</b>" для удаления конкретной строки. Удалим, например, "Hello World!":
<pre>
  esp32-alias><b>del 3</b>
  esp32-alias><b>list</b>
  % Alias "motor_on":
  % 1: pin 4 high delay 3000 low
  % 2: pin 4 low 2 high
  % --- END ---
</pre>
<b>ПРИМЕЧАНИЕ:</b> команда "delete" без аргументов удаляет последнюю строку. "delete all" — очищает весь алиас.
</p>

<p>
Теперь создадим алиас "<b>motor_off</b>":
<pre>
  esp32#>alias motor_off
  esp32-alias>pin 2 low 4 low
  esp32-alias>quit
  esp32#>
</pre>

Теперь у нас есть два алиаса с командами. Их можно выполнять с помощью команды "<b>exec</b>":
<pre>
  esp32#>exec motor_on
  esp32#>exec motor_off
</pre>
</p>

<p>
GPIO2 — нижний датчик, GPIO4 — верхний. Когда вода доходит до верхнего, напряжение на GPIO4 <i>повышается</i>. Когда опускается ниже нижнего — напряжение на GPIO2 <i>падает</i>.

Для таких событий (рост/падение сигнала) используется команда <b><a href="#if">if</a></b>:
<pre>
  esp32#>if falling 2 exec motor_on
  esp32#>if rising 4 exec motor_off
</pre>

Введеные условия (if) начинают работать сразу (если не было <a href="#delay">указанно обратное</a>), отслеживая уровень сигнала
на сенсорах и включая\выключая мотор в нужное время. Конечно, это очень упрощенная схема. В реальной придется указывать
 <i>максимальную разрешенную частоту</i> срабатывания событий.
</p>



<h2 id=cee><a href="#top">&#8686;</a>АЛИАСЫ: СОЗДАНИЕ, РЕДАКТИРОВАНИЕ, ВЫПОЛНЕНИЕ</h2>

<table>
<tr><td><b>Команда</b></td><td><b>Описание и примеры</b></td></tr>

<tr>
<td><b>alias <i>ИМЯ</i></b></td>
<td>
<p>
1. Создаёт пустой алиас с именем <i>ИМЯ</i> и входит в режим редактирования ("quit" для выхода)<br />
2. Если алиас уже существует — просто входит в режим редактирования
</p>

<p>
В режиме редактирования можно просматривать содержимое ("<b>list</b>"), удалять строки ("<b>delete</b>") или выйти командой "<b>quit</b>". Поскольку "exit" может быть частью алиаса, используется специальная команда "quit".
</p>

<p>
Все остальные команды просто добавляются в алиас как есть.
</p>

<p align="center">
Пример:
<pre>
esp32#>alias motor_off
% Вход в режим редактирования алиаса. Для выхода — "quit"
esp32-alias>pin 2 low 4 low
esp32-alias>echo Setting pins 2 and 4 low
esp32-alias>quit
esp32#>
</pre>
</p>
</td></tr>

<tr>
<td><b>show alias <i>[ИМЯ]</i></b></td>
<td>
<p>
<b>show alias</b> — выводит список всех определённых алиасов<br />
<b>show alias <i>ИМЯ</i></b> — показывает содержимое указанного алиаса
</p>

<p>
Пример: список алиасов
<pre>
esp32#>show alias
% Список алиасов:
% 1. "motor_off"
% 2. "motor_on"
% 3. "fail_2"
% 4. "test", пустой
esp32#>
</pre>

Пример: просмотр алиаса <b>motor_on</b>
<pre>
esp32#>sh al motor_on
% Alias "motor_on":
% 1: echo silent
% 2: uart 0
% 3: write Motor spin-up, wait...
% 4: pin 20 high delay 3000
% 5: write Done.\n
% 6: pin 21 high 20 low
% 7: write Pumping, wait...
% 8: exit
% 9: echo on
% --- END ---
</pre>
</p>
</td></tr>

<tr>
<td><b>exec <i>ИМЯ</i> [ИМЯ1 ИМЯ2 ... ИМЯn]</b></td>
<td>
<p>Выполняет указанный алиас (или список алиасов) поочерёдно.</p>

<p>
Пример: выполнение алиаса <b>motor_on</b>
<pre>
esp32#>exec motor_on
Motor spin-up, wait...Done.
Pumping, wait...
</pre>
</p>
</td></tr>
</table>

<h2 id=ifcond><a href="#top">&#8686;</a>УСЛОВИЯ, СОБЫТИЯ И ДЕЙСТВИЯ: КОМАНДА "IF"</h2>
<p>
Команда <b>if</b>, как можно было понять из примера с баком воды в начале этого документа, предназначена
для реагирования на <i>события</i> на пинах. Таких событий у нас два - нарастание напряжения (переход от логического 0 к логической 1, "rising") и
падение напряжения ("1" &rarr; "0" , "falling"). Регистрация таких событий возложена на аппаратную часть - процессор генерирует прерывания, когда данные события происходят.
</p>
<p>
Простейшее условие, которое реагирует на момент падения напряжения на GPIO2, запуская какую-то реакцию\действие:
<pre>
  esp32#>if falling 2 exec My_Alias
</pre>
Изначальное условие, на которое реагирует шелл (rising или falling) может быть расширено <i>дополнительными условиями:</i>
Добавим к условию срабатывания выше дополнительные условия: срабатывать только если GPIO4 находится в состоянии "0" а GPIO1 - в состоянии "1"
<pre>
  esp32#>if falling 2 <b>low 4 high 0</b> exec My_Alias
</pre>
Эти дополнительные условия проверяются в момент срабатывания основного, и, если условия не совпадают с реальными значениями на пинах, то такое событие отбрасывается,
а счетчик отброшенных событий увеличивается (см. команду "show if", колонка "Drops")
</p>


<p>
Можно ли вообще не указывать основное (rising/falling) событие, и что это будет означать?
</p>
<p>
Да, можно. Можно, например, написать следующее условие:
<pre>
  esp32#>if low 2 exec My_Alias
</pre>
Что произойдет в таком случае? ESPShell будет опрашивать состояние пина #2 <i>раз в секунду</i>, и, если условие совпадет, то будет выполнен
алиас My_Alias. Такие типы условий называются <i>переодическими</i> или <i>polling</i> -условиями. Частоту опроса можно установить, указав ключевое слово <b>poll</b>:
<pre>
  esp32#>if low 2 poll 10000 exec My_Alias &larr; опрашивать каждые 10 тысяч миллисекунд.
</pre>
Ключевое слово poll имеет смысл только лишь для переодических условий. Если условие rising или falling, то параметр poll будет проигнорирован а на экран будет выведено соответствующее предупреждение.
</p>

<p>
Можно ли как-то ограничить количество раз, которое данное условие сработает? Да, для этого существует ключевое слово
<b>max-exec</b>. Пример ниже ограничивает число срабатываний до пяти, а так же усложняет условие, добавив еще два пина:
<pre>
  esp32#>if low 2 low 4 high 0 poll 10000 max-exec 5 exec My_Alias
</pre>
Что будет происходить потом, после того, как условие отработает пять раз? Условие так и будет продолжать 
проверяться, но срабатывать не будет. Вместо этого будет увеличиваться счетчик отброшенных событий,
который можно увидеть в выводе команды "<b>show if</b>" (в колонке Drops):
</p>
<p align=center><img src="i/show_ifs_drops_max-exec.jpg" alt="show ifs command output" width="70%" height="70%"><br><i>Рис. 2: вывод команды "<b>show ifs</b>", достигли ограничения <b>max-exec</b></i></p>
<p>Обратите внимание на восклицательный знак рядом со счетчиком <i>Hits</i>, а так же на восклицательный знак 
(для монохромных мониторов): это указание на то, что условие выполнилось максимальное (<b>max-exec</b>) количество раз и более выполнятся не будет.
Командой <b>if clear</b> (а так же <b>every clear</b>) можно "обнулить" счетчики условий, как если бы эти условия никогда не отрабатывали</p>

<p>
При задании rising/falling условий следует обращать внимание на то, что эти условия проверяются в прерывании. Если никак
не ограничить частоту прерываний, то мы рискуем захлебнуться в потоке событий и количестве запущенных команд My_Alias. Простой дребезг может сгенерировать
тысячу прерываний за секунду, висящий пин ESP32, или какой-нибудь другой фактор приведут к тому, что изделие попросту повиснет.
</p>
<p>
Для борьбы с этой проблемой существует ключевое слово <b>rate-limit</b> (или просто <b>rate</b>, ключевые слова можно сокращать).
У этого ключевого слова есть один параметр - расстояние, в миллисекундах, между срабатываниями условия. То-есть, указав 
<b>rate-limit 500</b> мы гарантируем, что наше условие не будет срабатывать чем раз в пол-секунды (500 миллисекунд). События, которые будут приходить чаще, чем установленный лимит будут отбрасываться, а счетчик отброшенных событий - увеличиваться:
</p>
<p align=center><img src="i/show_ifs.jpg" alt="show ifs command output" width="70%" height="70%"><br><i>Рис. 2: Вывод команды "show ifs", rate-limit </i></p>


<table>
<tr><td><b>Команда</b></td><td><b>Описание и примеры</b></td></tr>

<tr><td><p><b>if</b></p></td><td>
<p>if <b>rising</b>|<b>falling</b> <i>PIN1</i> [<b>low</b>|<b>high</b> <i>PINn</i>]* [<b>max-exec</b> <i>NUM</i>] [<b>rate-limit</b> <i>MILLIS</i>] <b>exec</b> <i>ALIAS_NAME</i> </p>
<p>Условие на событие rising или falling, с опциональными дополнительными low/high условиями: как только уровент на PIN1 начинает падать (или нарастать) таким образом, что это совпадет с условием - условие сработает</p>
<p>Необязательный параметр <b>max-exec</b> задает максимальное количество срабатываний условия ("запускать не более, чем max-exec раз"); другой необязательный параметр, <b>rate-limit</b>, задает минимальный интервал, в миллисекундах, между срабатываниями условия.</p>
<p>Пример: реагировать на падение напряжения на GPIO2, но только, если пины GPIO4 и GPIO0 находятся в состоянии "low":
<pre>
  esp32#>if falling 2 low 0 low 4 exec my_action
</pre>
Пример: то же, что и в примере выше, но ограничить частоту вызовов - не чаще одного раза в секунду
<pre>
  esp32#>if falling 2 low 0 low 4 rate-limit 1000 exec my_action
</pre>
</p>

<p>if <b>low</b>|<b>high</b> <i>PIN1</i> [<b>low</b>|<b>high</b> <i>PINn</i>]* [<b>max-exec</b> <i>NUM</i>] [<b>poll</b> <i>MILLIS</i>] <b>exec</b> <i>ALIAS_NAME</i> </p>

<p>if <b>delete</b> [<b>gpio</b>] <i>NUM</i></p>
<p>if <b>delete</b> <b>all</b></p>
<p>if <b>clear</b> [<b>gpio</b>] <i>NUM</i></p>
<p>if <b>clear</b> <b>all</b></p>
<p>if <b>enable</b> NUM|<b>all</b></p>
<p>if <b>disable</b> NUM<b>all</b></p>

</td></tr>
</table>

<p>
Так же можно написать условие и вовсе без условий: это будет простым переодическим событием, которое будет исполняться безусловно:
<pre>
  esp32#>if poll 10000 exec My_Alias
</pre>
Такая запись хоть и возможна, и она будет работать, не является правильным способом задать переодическое событие.
Для переодических событий есть более удобная форма записи: команда <b>every</b>
</p>

<h2 id=every><a href="#top">&#8686;</a>ПЕРЕОДИЧЕСКИЕ СОБЫТИЯ</h2>
<p>
Для задания переодического выполнения можно воспользоваться командой <b>every</b>: в качестве аргументов она
принимает (помимо алиаса для выполнения) <i>частоту</i> выполнения и <i>задержку первого выполнения</i>
</p>
<p>
Если мы зададим такое простое переодическое условие,
<pre>
  esp32#>every 1 day exec My_Alias
</pre>
то <i>первое выполнение</i> произойдет сразу же, по нажатии на клавишу &lt;Enter&gt;, а вот последующие события будут происходить с интервалов в 24 часа.
Как быть, если нам не подходит вариант с выполнением первого события сразу же? Можно использьзовать ключевое слово 
<b>delay</b>:
<pre>
  esp32#>every 1 day delay 1 hour exec My_Alias
</pre>
В таком варианте команды, первое выполнение произойдет через час, а все последующие - с интервалов в 24 часа.
</p>
<table>
<tr><td><b>Команда</b></td><td><b>Описание и примеры</b></td></tr>

<tr><td><p><b>every</b></p></td><td>
<p>every NUM <b>milliseconds</b>|<b>seconds</b>|<b>minutes</b>|<b>hours</b>|<b>days</b> [<b>max-exec</b> <i>NUM</i>] [<b>delay</b> <i>MILLIS</i>] <b>exec</b> <i>ALIAS_NAME</i> </p>
<p>every <b>delete</b> NUM|<b>all</b></p>
<p>every <b>clear</b> NUM|<b>all</b></p>
<p>every <b>enable</b> NUM|<b>all</b></p>
<p>every <b>disable</b> NUM<b>all</b></p>

TBD:..
</td></tr>
</table>

</body>
</html>
