<!DOCTYPE html>
<html lang="en">
<head>
  <title>WiFi и сети</title>
  <link rel="stylesheet" href="espshell.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="ESPShell : конфигурирование и использование WiFi интерфейсов STA и AP">
  <meta name="author" content="Viacheslav Logunov">
  <meta name="repository" content="https://github.com/vvb333007/espshell">
  <meta name="project" content="ESPShell">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "headline": "ESPShell WiFi Commands",
    "description": "Detailed reference for configuring ESP32 WiFi interfaces via ESPShell CLI.",
    "author": {
      "@type": "Person",
      "name": "Viacheslav Logunov"
    },
    "publisher": {
      "@type": "Organization",
      "name": "ESPShell Project",
      "url": "https://github.com/vvb333007/espshell"
    },
}
</script>
</head>
<body>
<p align=center><a href="index.html"><img src="i/espshell_logo.jpg" alt="ESPShell для Ардуино :: WiFi и сети" width="70%" height="70%" /></a></p>
<h3 align=center><a href="Wifi.ru.html">[ На русском ]</a>&nbsp;&harr;&nbsp;<a href="Wifi.html">[ English ]</a></h3>
<p>
  <ul>
    <li><a href="#intro">WiFi в ESP32</a></li>
    <li><a href="#interfaces">Сетевые интерфейсы: AP и STA</a></li>
    <li><a href="#show">Отображение информации об интерфейсах и сетях</a></li>
    <li><a href="#show">Сканирование</a></li>
    <li><a href="#example">Пример: соединяемся с точкой доступа</a></li>
    <li><a href="#sta">Клиент</a></li>
    <li><a href="#example_ap">Пример: создаем точку доступа</a></li>
    <li><a href="#ap">Точка доступа</a></li>
 </ul>
</p>

<p><h2 id=intro><a href="#top">&#8686;</a>WiFi в ESP32</h2></p>
<p>
Большинство чипов Espressif оснащены встроенным модулем WiFi. Этот модуль разработан сторонними специалистами, поэтому значительная часть исходного кода, связанного с драйвером WiFi, недоступна. Вместо исходников поставляются только скомпилированные библиотеки и заголовочные файлы.  
При инициализации WiFi происходит загрузка микрокода во внутренний FPGA, который реализует всю функциональность беспроводного интерфейса.
</p>
<p>
Некоторые микроконтроллеры Espressif не имеют поддержки WiFi, а, например, ESP32-P4 использует конфигурацию с двумя MCU, где один из них выполняет роль WiFi-модуля.  
ESPShell поддерживает работу с чипами, у которых WiFi встроен аппаратно.
</p>
<p>
Пользовательские скетчи Arduino обычно используют «стандартную» библиотеку WiFi для ESP32.  
ESPShell не конфликтует с такими скетчами: если WiFi был инициализирован в коде, шелл корректно взаимодействует с уже работающим интерфейсом.  
Более того, один из основных сценариев использования ESPShell — это возможность <b>менять сетевые настройки на лету</b>: переопределять IP-адреса, пароли и имена сетей прямо во время работы пользовательского приложения.
</p>



<p><h2 id=interfaces><a href="#top">&#8686;</a>Сетевые интерфейсы: AP и STA</h2></p>
<p>
ESPShell поддерживает два сетевых WiFi-интерфейса: называется <b>sta</b> (Station) а другой - <b>ap</b> (Access Point).
Интерфейс <b>sta</b> используется для подключения к существующей сети (например, для доступа в интернет),  
а <b>ap</b> — для создания собственной точки доступа.  
Оба интерфейса можно использовать одновременно, что позволяет, например, организовать маршрутизацию и трансляцию адресов — так ESP32 может работать в режиме WiFi-удлинителя.
</p>
<p>
Как и в случае с другими интерфейсами ESP32, работа с WiFi начинается с перехода в нужный режим.  
Для этого выполните команду <b>wifi sta</b> или <b>wifi ap</b>:
<pre>
  esp32#>wifi sta
  esp32-sta>
</pre>

<pre>
  esp32#>wifi ap
  esp32-ap>
</pre>
</p>
<p>
Чтобы выйти из режима конфигурации WiFi, используйте команду <b>exit</b> (или нажмите Ctrl+Z).
</p>

Внимание: для того, чтобы была возможность просматривать настройки wifi (командой "show wifi ...") интерфейсы должны быть созданы:
это делает либо скетч, либо вы сам, вручную, выполнив любую команду, начинающуюся с "wifi" (например "<b>wifi sta</b>")

<p><h2 id=show><a href="#top">&#8686;</a>Отображение информации об интерфейсах и сетях</h2></p>
<p>
Для просмотра состояния и параметров WiFi-интерфейса используется команда <b>show wifi</b> с нужным параметром:
<pre>
  esp32#>show wifi ap      &larr; информация об интерфейсе AP
  esp32#>show wifi sta     &larr; информация об интерфейсе STA
  esp32#>show wifi clients &larr; информация о клиентах (STA) на нашей точке доступа
</pre>
Ниже показан пример вывода команды <b>show wifi sta</b> при отсутствии соединения.  
Строка &laquo;Configured:&raquo; отображает информацию, считанную из flash-памяти (если она была туда сохранена ранее командой <b>wifi storage flash</b>).
</p>
<p align=center>
<img src="i/show_wifi_sta_down.jpg" alt="show wifi sta down" width="80%" height="80%" />
<br>
<i>Рис. 1: Вывод команды <b>show wifi sta</b> (соединение не установлено)</i>
</p>


<p><h2 id=scan><a href="#top">&#8686;</a>Сканирование WiFi сети</h2></p>
<p>
Сканирование применяется для получения списка доступных сетей, а так же - параметров той или иной точки доступа. 
</p>
<p>
ESP32 поддерживает два режима сканирования: активное (команда <b>scan</b>) и пассивное (команда <b>scan passive</b>).
При активном сканировании в эфир отправляются WiFi Probe Request, и это режим по умолчанию — команда <b>scan</b> без параметров выполняет именно активное сканирование.  
Если добавить аргумент <b>passive</b>, ESPShell выполнит пассивное сканирование: никаких пакетов в эфир не отправляется, устройство просто «слушает» эфир и собирает информацию о найденных точках доступа.
<pre>
  esp32#><b>scan passive</b>
</pre>
</p>
<p>
Если передать команде <b>scan</b> аргумент <b>bssid</b> и MAC-адрес точки доступа (отображается в выводе команды <b>scan</b> в колонке BSSID), можно получить расширенную информацию о конкретной сети:
<pre>
esp32-ap><b>scan bssid CC50:0AC2:3E44</b>
% Starting active WiFi scan (obtaining details for the BSSID)...
%Information on AP "SomKiat Suksamran" (BSSID: CC50:0AC2:3E44)
%
% Security: [* WPA1/2], Pairwise cipher: TKIP_CCMP, Group cipher: TKIP
% WPS is not supported
% Channels: 7 (primary), secondary channel is above primary
%
% Signal power (RSSI): -60 dBm, used antenna#0
% Bandwidth: 40MHz
% PHY enabled modes: 802.11bgn
%
% FTM role: no support for Fine Time Measurement
% Scanning took 3.43 seconds
esp32-ap>
</pre>
</p>


<p><h2 id=example><a href="#top">&#8686;</a>Пример: установление соединения с точкой доступа</h2></p>
<p>
Прежде чем переходить к подробному описанию команд, попробуем подключиться к одной из доступных точек доступа.  
Для этого войдём в режим конфигурации WiFi-станции (STA):
<pre>
  esp32#><b>wifi sta</b>
  esp32-sta>
</pre>
В этом режиме становятся доступны команды для настройки параметров WiFi-станции — имени сети, пароля, IP- и MAC-адресов, маски сети, DNS-серверов и прочего.  
Полный список команд можно увидеть, выполнив <b>?</b> (знак вопроса):
</p>

<p align=center>
<img src="i/wifi_sta_commands_list.jpg" alt="WiFi STA commands list" width="80%" height="80%" />
<br>
<i>Рис. 2: Список доступных команд в режиме STA</i>
</p>

<p>
Чтобы просмотреть список доступных WiFi-сетей и их характеристики, используйте команду <b>scan</b>.  
Она выполняет сканирование (активное или пассивное, в зависимости от параметра) и выводит найденные сети:
<pre>
esp32-sta><b>scan</b>
% Starting active WiFi scan (obtaining a list of available networks)...
% # |Ch| Network Name (SSID)             | AP MAC (BSSID) | RSSI | Security
% --+--+---------------------------------+----------------+------+--------------
% 1 | 7| SomKiat Suksamran               | CC50:0AC2:3E44 | -60  | * WPA1/2
% 2 |13| TECNO SPARK 20 Pro              | 623A:D9D7:FCD9 | -62  | * WPA2
% 3 | 3| Cherish_2.4G                    | E4FA:C45F:DCFF | -63  | * WPA2
% 4 | 1| ORNSHOUSE_2.4GHz                | 3E93:F42D:9DEC | -76  | * WPA1/2
% 5 | 5| hidden                          | 6420:E063:B383 | -84  | * WPA2
% 6 |13| hidden                          | 6420:E387:C756 | -86  | * WPA2
% 7 |13| Nonginin_2.4G                   | 6620:E317:C756 | -86  | * WPA2
% 8 | 1| ORNSHOUSE_2.4GHz                | CA9F:1A90:1F30 | -91  | * WPA1/2
% 9 |11| VR CHINA EXPRSS                 | 6CA5:D11F:99B5 | -91  | * WPA1/2
% 10| 9| hidden                          | 9CA2:F401:A666 | -92  | * WPA2
% 11| 4| hidden                          | 6420:E386:23FE | -93  | * WPA2
% 12| 4| TrueGigatexFiber_2.4G_3FA       | 6620:E316:23FE | -93  | * WPA2
% 13| 9| GWF @aonang                     | 9EA2:F421:A666 | -93  | * WPA2
% 14|11| Get Well Fitness@aonang         | 9056:DE3F:0A06 | -93  | * WPA1/2
% 15| 7| Eud Service_2.4                 | F4E8:4F4E:66F0 | -94  | * WPA1/2
%
% Total: 15 access points
%
% Legend ("security" column):
%"*" : PSK (Preshared key)
%"+" : PSK (Preshared key, mixed mode)
%"$" : ENT (Enterprise security)
%"-" : OPEN (Open access)
% Scanning took 3.63 seconds
esp32-sta>
</pre>
Выберем сеть &laquo;SomKiat Suksamran&raquo; и подключимся к ней с паролем <b>Klong1414</b>.  
Обратите внимание, что имя сети записано в кавычках — это необходимо, если в SSID есть пробелы. Без кавычек шелл воспримет каждое слово как отдельный аргумент команды.  
Как и в других интерфейсах ESPShell (например, UART или I2C), интерфейс активируется командой <b>up</b>.  
У неё несколько параметров: первый — имя или MAC-адрес точки доступа, второй — пароль (если он есть), третий — <b>auto-reconnect</b>, включающий автоматическое восстановление соединения при обрыве.
<pre>
esp32-sta>up "SomKiat Suksamran" Klong1414 auto
% Connect to a network using SSID
% Auto-reconnect enabled
% WIFI STA: Connected to the network. Configuring IP..
% Interface WIFI STA got IP 192.168.1.5, mask 255.255.255.0, gw 192.168.1.1 (changed)
% WIFI STA: propagating DNS servers to the AP interface..
</pre>
Команда <b>up</b> выполняется асинхронно — процесс подключения идёт в фоне.  
О факте установления соединения можно узнать по сообщениям шелла или командой <b>show wifi sta</b>.
</p>

<p align=center>
<img src="i/show_wifi_sta_up.jpg" alt="show wifi sta" width="80%" height="80%" />
<br>
<i>Рис. 3: Вывод команды <b>show wifi sta</b> — соединение установлено</i>
</p>






<p><h2 id=sta><a href="#top">&#8686;</a>Клиент (STA)</h2></p>
<p>
Работа со STA-интерфейсом начинается с команды <b>wifi sta</b>.  
Рекомендуется выполнять настройку интерфейса <b>до</b> подключения к сети — особенно если вы планируете использовать статический IP-адрес.  
Изменить IP можно и после подключения, но это приведёт к переподключению.
</p>

<table><tr><th>Команда</th><th>Описание</th></tr>
<tr><td><p>ip</p></td><td>
<p><b>ip address</b> <i>ADDRESS/PREFIX</i> | <b>dhcp</b> [<b>dns</b> <i>ADDRESS</i> | <b>gw</b> <i>ADDRESS</i>]*</p>
<p>
Задаёт статический или динамический IP-адрес, маску сети, шлюз по умолчанию и DNS-серверы.
</p>
<p>
По умолчанию на STA-интерфейсе включён DHCP-клиент, что эквивалентно команде:
<pre>
  esp32-sta><b>ip address dhcp</b>
</pre>
Эта команда указывает шеллу, что все сетевые параметры (адрес, маска, DNS и шлюз по умолчанию) будут получены от DHCP-сервера точки доступа.  
Если же нужно задать статический адрес, команда будет выглядеть так:
<pre>
  esp32-sta><b>ip address 192.168.0.2/24 gw 192.168.0.1</b>
</pre>
Маска сети указывается в формате CIDR (в примере — /24), то есть через длину префикса.  
В ESPShell не используются привычные записи масок вроде <b>255.255.255.0</b>.  
Если маску не указать, она считается равной /32 (255.255.255.255).  
При попытке установить такой адрес интерфейс автоматически скорректирует маску до /24.  
Маска /32 обычно используется в PPP-соединениях, которые ESPShell пока не поддерживает.
</p>
<p>
Если задать статический IP без указания маршрута по умолчанию (<b>gw</b> <i>A.B.C.D</i>), шелл автоматически подставит шлюз <b>A.B.C.1</b> — то есть заменит последний октет на 1.
</p>
<p>
Оба примера ниже эквивалентны:
<pre>
  esp32-sta><b>ip address 192.168.0.2/24 gw 192.168.0.1</b>
</pre>
<pre>
  esp32-sta><b>ip address 192.168.0.2</b>   &larr; маска /24, шлюз 192.168.0.1
</pre>
</p>
<p>
Другой пример: получать настройки от DHCP-сервера, но использовать статические DNS-серверы Google:
<pre>
  esp32-sta><b>ip address dhcp dns 8.8.8.8 dns 4.4.4.4</b>
</pre>
Чтобы задать два DNS-сервера (основной и резервный), перед каждым адресом добавляется ключевое слово <b>dns</b>.
</p>
</td></tr>

<tr><td><p>up</p></td><td>
<p><b>up</b> [<i>NETWORK_NAME_OR_MAC</i> [<i>PASSWORD</i> [<b>auto-reconnect</b>]]]</p>
<p>
Включает интерфейс (подключается к точке доступа).  
Команду <b>up</b> без параметров можно использовать для повторного подключения, если ESPShell помнит параметры предыдущего успешного соединения (см. <a href="#storage">storage</a>).
</p>
<p>
Обычно указываются два параметра — имя сети (или MAC, если SSID скрыт) и пароль.  
Для открытых сетей пароль можно опустить или указать пустые кавычки <b>&quot;&quot;</b>.
</p>
<p>
Примеры:
<pre>
  esp32-sta><b>up McDonalds_FREE</b>                    - без пароля  
  esp32-sta><b>up McDonalds_FREE "" auto-reconnect</b>  - без пароля, с авто-переподключением  
  esp32-sta><b>up McDonalds myPaSsword</b>              - с паролем  
  esp32-sta><b>up McDonalds myPaSsword auto-reconnect</b> - с паролем и авто-переподключением
</pre>
</p>
</td></tr>

<tr><td><p>down</p></td><td>
<p><b>down</b></p>
<p>
Отключает интерфейс: прерывает процесс подключения или разрывает активное соединение.
</p>
</td></tr>

<tr><td><p>mac</p></td><td>
<p><b>mac</b> <i>MAC_ADDRESS</i></p>
<p>
Задаёт новый MAC-адрес.  
Изменить MAC можно «на лету», но если STA-интерфейс уже подключён, смена адреса вызовет переподключение.
</p>
<p>
Шелл принимает разные форматы записи, например:
AA:BB:11:22:33:44, aaBB:1234:56Ff или 001122334455 — все они корректны.
</p>
<p>
Пример:
<pre>
  esp32-sta><b>mac 0044:afaf:dead</b>
</pre>
Нельзя задать MAC, совпадающий с уже используемым (например, у AP-интерфейса).  
Также не допускаются адреса, у которых установлен младший бит первого байта (адрес 0133:3333:3333 — некорректен, 0233:3333:3333 — корректен).  
Широковещательные адреса также не могут использоваться в качестве MAC интерфейса.
</p>
</td></tr>

<tr><td><p>hostname</p></td><td>
<p><b>hostname</b> <i>TEXT</i></p>
<p>
Задаёт новый hostname. В реализации от Espressif мы имеем уникальный hostname на каждом сетевом интерфейсе.  
</p>
<p>
Пример:
<pre>
  esp32-sta><b>hostname mars.local</b>
</pre>
</p>
</td></tr>

</table>






<p><h2 id=ap><a href="#top">&#8686;</a>Точка доступа (AP)</h2></p>
<p>
Работа с AP-интерфейсом начинается с команды <b>wifi ap</b>.  
</p>

<table><tr><th>Команда</th><th>Описание</th></tr>
<tr><td><p>ip</p></td><td>
<p><b>ip address</b> <i>ADDRESS/PREFIX</i> [<b>dns</b> <i>ADDRESS</i>]*</p>
<p>
Задаёт статический или динамический IP-адрес, маску сети и DNS-серверы; задать шлюз по умолчанию так же возможно, через парамер gw как и в STA интерфейсе, но это , скорее всего, приведет к неработоспособности клиентов.


</p>

Обратите внимание: если не задать DNS, то, по умолчанию DNS адрес будет установлен таким же, как адрес интерфейса.
В таком случае, при установлении соединения по интерфейсу STA, настройки DNS серверов, полученные интерфейсом STA будут распостранены и на интерфейс AP. Чтобы запретить автоматическое изменение DNS серверов на интерфейсе AP, следует задать их явно, при задании IP адреса:
<pre>
  esp32-ap><b>ip address 192.168.4.1/24 dns 8.8.8.8</b>
</pre>

Если же адрес задать так:

<pre>
  esp32-ap><b>ip address 192.168.4.1/24</b>
</pre>

то DNS сервер будет установлен в 192.168.4.1, но как только STA интерфейс установит соединение и получит значения DNS серверов по DHCP,
настройки DNS AP тут же будут изменены. Такое поведение необходимо для работы в режиме маршрутизатора.

Так же, как и в интерфейсе STA, маска сети указывается в формате CIDR (в примере — /24), то есть через длину префикса.  
</p>

</td></tr>

<tr><td><p>up</p></td><td>
<p><b>up</b> [<i>NETWORK_NAME</i> [<i>PASSWORD</i> [<b>max-conn</b> <i>NUM</i>]]]</p>
<p>
Включает интерфейс (создает точку доступа).  
Команду <b>up</b> без параметров можно использовать для повторного подключения, если ESPShell помнит параметры предыдущего успешного соединения (см. <a href="#storage">storage</a>).
</p>
<p>
Обычно указываются два параметра — имя сети и пароль.  
Для открытых сетей пароль можно опустить или указать пустые кавычки <b>&quot;&quot;</b>. Дополнительно можно указать максимальное количество подключений к вашей точке, воспользовавшись ключевым словом <b>max-conn</b> (по умолчанию max-conn равен 4)
</p>
<p>
Примеры:
<pre>
  esp32-ap><b>up McDonalds_FREE</b>                    - Открытая сеть, без пароля, макс. 4 клиента
  esp32-ap><b>up McDonalds_FREE "" max-conn 1</b>      - без пароля, 1 клиент
  esp32-ap><b>up McDonalds myPaSsword</b>              - с паролем  
</pre>
</p>
</td></tr>

<tr><td><p>down</p></td><td>
<p><b>down</b></p>
<p>
Отключает интерфейс: выключает точку доступа, разрывает все установленные клиентами соединения.
</p>
</td></tr>

<tr><td><p>mac</p></td><td>
<p><b>mac</b> <i>MAC_ADDRESS</i></p>
<p>
Задаёт новый MAC-адрес.  
Интерфейс должен быть "up", для того, чтобы можно было менять MAC адресс, это ограничение драйвера WiFi
</p>
<p>
Шелл принимает разные форматы записи, например:
AA:BB:11:22:33:44, aaBB:1234:56Ff или 001122334455 — все они корректны.
</p>
<p>
Пример:
<pre>
  esp32-sta><b>mac 0044:afaf:dead</b>
</pre>
Нельзя задать MAC, совпадающий с уже используемым (например, у STA-интерфейса).  
Также не допускаются адреса, у которых установлен младший бит первого байта (адрес 0133:3333:3333 — некорректен, 0233:3333:3333 — корректен).  
Широковещательные адреса также не могут использоваться в качестве MAC интерфейса.
</p>
</td></tr>

<tr><td><p>hostname</p></td><td>
<p><b>hostname</b> <i>TEXT</i></p>
<p>
Задаёт новый hostname. В реализации от Espressif мы имеем уникальный hostname на каждом сетевом интерфейсе.  
</p>
<p>
Пример:
<pre>
  esp32-sta><b>hostname snikers.local</b>
</pre>
</p>
</td></tr>

<tr><td><p>dhcp</p></td><td>
<p><b>dhcp</b> <b>enable | disable</b></p>
<p><b>dhcp</b> <b>A.B.C.D [COUNT]</b></p>
<p>
Включить \ выключить DHCP сервер, задать диапазон выдаваемых клиентам IP адресов. Настройки по умолчанию:
<pre>
  esp32-ap>dhcp 192.168.4.2 15    &larr; выдавать адреса 192.168.4.2 ... 192.168.4.17
  esp32-ap>dhcp enable            &larr; включить DHCP сервер
</pre>
</p>
</td></tr>


<tr><td><p>nat</p></td><td>
<p><b>nat</b> <b>enable | disable</b></p>
<p>
Включить \ выключить NAT. Настройки по умолчанию:
<pre>
  esp32-ap>nat disable
</pre>
При включенном NAT, работающей точке доступа и установленному соединению на STA интерфейсе, ESP32 превратится в маленький маршрутизатор,
способный выдавать около 14мбит\сек работая удлинителем WiFi.
</p>
</td></tr>



</table>



<!-- TO BE DONE -->
<p><h2 id=show_clients><a href="#top">&#8686;</a>Отображение информации о клиентах</h2></p>
<p><h2 id=storage><a href="#top">&#8686;</a>Запоминание настроек</h2></p>
<p><h2 id=memory_footprint><a href="#top">&#8686;</a>Требования к ресурсам (память)</h2></p>


</body>
</html>
</body>
</html>
