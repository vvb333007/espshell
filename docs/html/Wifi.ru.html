<!DOCTYPE html>
<html lang="en">
<head>
  <title>WiFi и сети</title>
  <link rel="stylesheet" href="espshell.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="ESPShell : конфигурирование и использование WiFi интерфейсов STA и AP">
  <meta name="author" content="Viacheslav Logunov">
  <meta name="repository" content="https://github.com/vvb333007/espshell">
  <meta name="project" content="ESPShell">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "headline": "ESPShell WiFi Commands",
    "description": "Detailed reference for configuring ESP32 WiFi interfaces via ESPShell CLI.",
    "author": {
      "@type": "Person",
      "name": "Viacheslav Logunov"
    },
    "publisher": {
      "@type": "Organization",
      "name": "ESPShell Project",
      "url": "https://github.com/vvb333007/espshell"
    }
}
</script>

</script>
</head>
<body>
<p align=center><a href="index.html"><img src="i/espshell_logo.jpg" alt="ESPShell для Ардуино :: WiFi и сети" width="70%" height="70%" /></a></p>
<h3 align=center><a href="Wifi.ru.html">[ На русском ]</a>&nbsp;&harr;&nbsp;<a href="Wifi.html">[ English ]</a></h3>
<p>
  <ul>
    <li><a href="#intro">WiFi в ESP32</a></li>
    <li><a href="#interfaces">Сетевые интерфейсы: AP и STA</a></li>
    <li><a href="#show">Отображение информации об интерфейсах и сетях</a></li>
    <li><a href="#scan">Сканирование</a></li>
    <li><a href="#time">Синхронизация времени по NTP</a></li>
    <li><a href="#example">Пример: соединяемся с точкой доступа</a></li>
    <li><a href="#sta">Клиент (STA)</a></li>
    <li><a href="#example_ap">Пример: создаем точку доступа</a></li>
    <li><a href="#ap">Точка доступа (AP)</a></li>
    <li><a href="#show_clients">Отображение информации о клиентах</a></li>
    <li><a href="#storage">Запоминание настроек</a></li>
    <li><a href="#memory_footprint">Требования к ресурсам (память)</a></li>
 </ul>
</p>

<p><h2 id=intro><a href="#top">&#8686;</a>WiFi в ESP32</h2></p>
<p>
Большинство чипов Espressif оснащены встроенным модулем WiFi. Этот модуль разработан сторонними специалистами, 
поэтому значительная часть исходного кода, связанного с драйвером WiFi, недоступна. Вместо исходников 
поставляются только скомпилированные библиотеки и заголовочные файлы.  
При инициализации WiFi происходит загрузка микрокода во внутренний FPGA, который реализует всю функциональность
 беспроводного интерфейса.
</p>
<p>
Некоторые микроконтроллеры Espressif не имеют <b>встроенной</b> поддержки WiFi, а, например, ESP32-P4 
использует конфигурацию с двумя MCU, где один из них выполняет роль WiFi-модуля (сам ESP32-P4 встроенного WiFi не имеет).  
Внимание: ESPShell поддерживает работу лишь с чипами, у которых WiFi <b>встроен аппаратно</b> (например ESP32, ESP32-S3, ESP32C6).
</p>
<p>
Пользовательские скетчи Arduino обычно используют «стандартную» библиотеку WiFi для ESP32, которая представляет собой обертку для ESP-IDF API.
ESPShell не конфликтует с такими скетчами, т.к. хоть ничего и не знает про WiFi Library, но пользуется тем же самым API и не хранит указателей на интерфейсы или их настройки: 
если WiFi был инициализирован в коде скетча, шелл корректно взаимодействует с <b>уже работающим интерфейсом</b>.  
Более того, один из основных сценариев использования ESPShell — это возможность <b>менять сетевые настройки на лету</b>: переопределять IP-адреса, пароли и имена сетей прямо во время работы пользовательского приложения.
Если же пользовательский скетч ничего не знает про WiFi и его инициализацию, но хочет использовать BSD sockets API, то можно вручную сконфигурировать сетевые подключения и продолжить выполнение скетча (прервать скетч можно нажав Ctrl+C, а продолжить его выполнение - командой "resume").
</p>

<p>
</p>



<p><h2 id=interfaces><a href="#top">&#8686;</a>Сетевые интерфейсы: AP и STA</h2></p>
<p>
ESPShell поддерживает два сетевых WiFi-интерфейса: один называется <b>sta</b> (Station) а другой - <b>ap</b> (Access Point).
Интерфейс <b>sta</b> используется для подключения к существующей сети (например, для доступа в интернет),  
а <b>ap</b> — для создания собственной точки доступа.  
Оба интерфейса можно использовать одновременно, что позволяет, например, организовать маршрутизацию и трансляцию адресов — так ESP32 может работать в режиме WiFi-удлинителя.
</p>
<p>
Как и в случае с другими интерфейсами ESP32, работа с WiFi начинается с перехода в нужный режим.  
Для этого выполните команду <b>wifi sta</b> или <b>wifi ap</b>:
<pre>
  esp32#>wifi sta
  esp32-sta>
</pre>

<pre>
  esp32#>wifi ap
  esp32-ap>
</pre>
</p>
<p>
Чтобы выйти из режима конфигурации WiFi, используйте команду <b>exit</b> (или нажмите Ctrl+Z).
</p>

Внимание: для того, чтобы была возможность просматривать настройки wifi (командой "show wifi ...") интерфейсы должны быть созданы:
это делает либо скетч (вызвав <i>WiFi.begin(...)</i>), либо пользователь, вручную, выполнив любую команду, 
начинающуюся с "<b>wifi</b>" (например "<b>wifi sta</b>")

<p><h2 id=show><a href="#top">&#8686;</a>Отображение информации об интерфейсах и сетях</h2></p>
<p>
Для просмотра состояния и параметров WiFi-интерфейса используется команда <b>show wifi</b> с нужным параметром:
<pre>
  esp32#>show wifi ap      &larr; информация об интерфейсе AP
  esp32#>show wifi sta     &larr; информация об интерфейсе STA
  esp32#>show wifi clients &larr; информация о клиентах (STA) на нашей точке доступа
</pre>
Ниже показан пример вывода команды <b>show wifi sta</b> при отсутствии соединения.  
Строка &laquo;Configured:&raquo; отображает информацию, считанную из flash-памяти (если она была туда сохранена ранее командой <b>wifi storage flash</b>).
</p>
<p align=center>
<img src="i/show_wifi_sta_down.jpg" alt="show wifi sta down" width="80%" height="80%" />
<br>
<i>Рис. 1: Вывод команды <b>show wifi sta</b> (соединение не установлено)</i>
</p>


<p><h2 id=scan><a href="#top">&#8686;</a>Сканирование WiFi сети</h2></p>
<p>
Сканирование применяется для получения списка доступных сетей, а так же - параметров той или иной точки доступа. 
</p>
<p>
ESP32 поддерживает два режима сканирования: активное (команда <b>scan</b>) и пассивное (команда <b>scan passive</b>).
При активном сканировании в эфир отправляются WiFi Probe Request, и это режим по умолчанию — команда <b>scan</b> без параметров выполняет именно активное сканирование.  
Если добавить аргумент <b>passive</b>, ESPShell выполнит пассивное сканирование: никаких пакетов в эфир не отправляется, устройство просто «слушает» эфир и собирает информацию о найденных точках доступа.
<pre>
  esp32#><b>scan passive</b>
</pre>
</p>
<p>
Если передать команде <b>scan</b> аргумент <b>bssid</b> и MAC-адрес точки доступа (отображается в выводе команды <b>scan</b> в колонке BSSID), можно получить расширенную информацию о конкретной сети:
<pre>
esp32-ap><b>scan bssid CC50:0AC2:3E44</b>
% Starting active WiFi scan (obtaining details for the BSSID)...
%Information on AP "SomKiat Suksamran" (BSSID: CC50:0AC2:3E44)
%
% Security: [* WPA1/2], Pairwise cipher: TKIP_CCMP, Group cipher: TKIP
% WPS is not supported
% Channels: 7 (primary), secondary channel is above primary
%
% Signal power (RSSI): -60 dBm, used antenna#0
% Bandwidth: 40MHz
% PHY enabled modes: 802.11bgn
%
% FTM role: no support for Fine Time Measurement
% Scanning took 3.43 seconds
esp32-ap>
</pre>

Команда сканирования доступна для обоих интерфейсов (т.е. может быть выполнена в любом из конфигурационных режимов - STA, AP, AP+STA)
</p>


<p><h2 id=scan><a href="#top">&#8686;</a>Синхронизация времени по NTP</h2></p>
<p>
При конфигурировании WiFi есть возможность запустить NTP-клиента, который будет переодически синхъронизировать время
с удаленным сервером. Адреса NTP серверов по умолчанию получаются от DHCP сервера. Если получить адреса NTP серверов от DHCP не удалось,
то будут использованы статические сервера time.windows.com и pool.ntp.org. Если получить адрес NTP сервера по DHCP удалось, то 
в добавление к адресу полученному от DHCP сервера, так же будут добавлены два статическиъ сервера (time.windows.com и pool.ntp.org).
</p>

<p>
Можно сконфигурировать только статические адреса NTP серверов. В таком случае предложение от DHCP сервера будет проигнорировано. Данная версия поддерживает до трех NTP серверов:
один может быть поолучен от DHCP сервера а два других (или все три!) могут быть сконфигурированы статически.
</p>
<p>
По умолчанию NTP клиент остановлен и для его запуска надо выполнить команду "<b>ntp enable</b>" на одном из WiFi интерфейсов.
Команда "<b>ntp</b>" может обрабатывать последовательность аргументов: вместо
<pre>
  esp32-sta>ntp dhcp
  esp32-sta>ntp enable
</pre>
можно написать:
<pre>
  esp32-sta>ntp dhcp enable
</pre>
Для того, чтобы получать адреса NTP от DHCP нужно выполнить команду "<b>ntp dhcp</b>". Для того, чтобы 
использовать свои адреса NTP нужно выполнить команду "<b>ntp pool.ntp.org</b>": имя сервера приведено для примера.
Вместо имен серверов можно использовать IP адреса

<pre>
Пример: задаем три статических сервера, предварительно остановив сервис

  esp32-sta>ntp disable 1.1.1.1 time.windows.com 2.2.2.2
</pre>

Для того, чтобы задать и DHCP сервера и статические вместе, следует использовать такой синтаксис команды:

<pre>
Пример: задаем 2 статических сервера, и один по DHCP

  esp32-sta>ntp 1.1.1.1 time.windows.com dhcp
</pre>

<b>Обратите внимание</b>, что для случая со смешанными серверами NTP, ключевое слово "dhcp" в команде "ntp" ставится ПОСЛЕ статических адресов!
Если же сделать наоборот, то есть написать что-то вроде "<b>ntp dhcp 1.1.1.1</b>", то ключевое слово dhcp будет проигнорировано.

<pre>
  esp32-sta>ntp 1.1.1.1 time.windows.com dhcp   &larr; правильное задание статических и динамических серверов
  esp32-sta>ntp dhcp 1.1.1.1 time.windows.com   &larr; "<b>dhcp</b>" будет проигнорировано!
</pre>

</p>

<p>
Если соединение WiFi установлено, IP адрес получен и NTP серверы сконфигурированы, то через несколько секунд появится сообщение о том, что время синхзронизировано.
Удостовериться в этом можно командой "<b>show time</b>"
</p>



<p><h2 id=example><a href="#top">&#8686;</a>Пример: установление соединения с точкой доступа</h2></p>
<p>
Прежде чем переходить к подробному описанию команд, попробуем подключиться к одной из доступных точек доступа.  
Для этого войдём в режим конфигурации WiFi-станции (STA):
<pre>
  esp32#><b>wifi sta</b>
  esp32-sta>
</pre>
В этом режиме становятся доступны команды для настройки параметров WiFi-станции — имени сети, пароля, IP- и MAC-адресов, маски сети, DNS-серверов и прочего.  
Полный список команд можно увидеть, выполнив <b>?</b> (знак вопроса):
</p>

<p align=center>
<img src="i/wifi_sta_commands_list.jpg" alt="WiFi STA commands list" width="80%" height="80%" />
<br>
<i>Рис. 2: Список доступных команд в режиме STA</i>
</p>

<p>
Чтобы просмотреть список доступных WiFi-сетей и их характеристики, используйте команду <b>scan</b>.  
Она выполняет сканирование (активное или пассивное, в зависимости от параметра) и выводит найденные сети:
<pre>
esp32-sta><b>scan</b>
% Starting active WiFi scan (obtaining a list of available networks)...
% # |Ch| Network Name (SSID)             | AP MAC (BSSID) | RSSI | Security
% --+--+---------------------------------+----------------+------+--------------
% 1 | 7| SomKiat Suksamran               | CC50:0AC2:3E44 | -60  | * WPA1/2
% 2 |13| TECNO SPARK 20 Pro              | 623A:D9D7:FCD9 | -62  | * WPA2
% 3 | 3| Cherish_2.4G                    | E4FA:C45F:DCFF | -63  | * WPA2
% 4 | 1| ORNSHOUSE_2.4GHz                | 3E93:F42D:9DEC | -76  | * WPA1/2
% 5 | 5| hidden                          | 6420:E063:B383 | -84  | * WPA2
% 6 |13| hidden                          | 6420:E387:C756 | -86  | * WPA2
% 7 |13| Nonginin_2.4G                   | 6620:E317:C756 | -86  | * WPA2
% 8 | 1| ORNSHOUSE_2.4GHz                | CA9F:1A90:1F30 | -91  | * WPA1/2
% 9 |11| VR CHINA EXPRSS                 | 6CA5:D11F:99B5 | -91  | * WPA1/2
% 10| 9| hidden                          | 9CA2:F401:A666 | -92  | * WPA2
% 11| 4| hidden                          | 6420:E386:23FE | -93  | * WPA2
% 12| 4| TrueGigatexFiber_2.4G_3FA       | 6620:E316:23FE | -93  | * WPA2
% 13| 9| GWF @aonang                     | 9EA2:F421:A666 | -93  | * WPA2
% 14|11| Get Well Fitness@aonang         | 9056:DE3F:0A06 | -93  | * WPA1/2
% 15| 7| Eud Service_2.4                 | F4E8:4F4E:66F0 | -94  | * WPA1/2
%
% Total: 15 access points
%
% Legend ("security" column):
%"*" : PSK (Preshared key)
%"+" : PSK (Preshared key, mixed mode)
%"$" : ENT (Enterprise security)
%"-" : OPEN (Open access)
% Scanning took 3.63 seconds
esp32-sta>
</pre>
Выберем сеть &laquo;SomKiat Suksamran&raquo; и подключимся к ней с паролем <b>Klong1414</b>.  
Обратите внимание, что имя сети записано в кавычках — это необходимо, если в SSID есть пробелы. Без кавычек шелл воспримет каждое слово как отдельный аргумент команды.  
Как и в других интерфейсах ESPShell (например, UART или I2C), интерфейс активируется командой <b>up</b>.  
У неё несколько параметров: первый — имя или MAC-адрес точки доступа, второй — пароль (если он есть), третий — <b>auto-reconnect</b>, включающий автоматическое восстановление соединения при обрыве.
<pre>
esp32-sta>up "SomKiat Suksamran" Klong1414 auto
% Connect to a network using SSID
% Auto-reconnect enabled
% WIFI STA: Connected to the network. Configuring IP..
% Interface WIFI STA got IP 192.168.1.5, mask 255.255.255.0, gw 192.168.1.1 (changed)
% WIFI STA: propagating DNS servers to the AP interface..
</pre>
Команда <b>up</b> выполняется асинхронно — процесс подключения идёт в фоне.  
О факте установления соединения можно узнать по сообщениям шелла или командой <b>show wifi sta</b>.
</p>

<p align=center>
<img src="i/show_wifi_sta_up.jpg" alt="show wifi sta" width="80%" height="80%" />
<br>
<i>Рис. 3: Вывод команды <b>show wifi sta</b> — соединение установлено</i>
</p>


<p>
Просто? Довольно просто. Теперь - к подробностям.
</p>





<p><h2 id=sta><a href="#top">&#8686;</a>Клиент (STA)</h2></p>
<p>
Работа со STA-интерфейсом начинается с команды <b>wifi sta</b>.  
Рекомендуется выполнять настройку интерфейса <b>до</b> подключения к сети — особенно если вы планируете использовать статический IP-адрес.  
Изменить IP можно и после подключения, но это приведёт к переподключению.
</p>

<table><tr><th>Команда</th><th>Описание</th></tr>
<tr><td><p>ip</p></td><td>
<p><b>ip address</b> <i>ADDRESS/PREFIX</i> | <b>dhcp</b> [<b>dns</b> <i>ADDRESS</i> | <b>gw</b> <i>ADDRESS</i>]*</p>
<p>
Задаёт статический или динамический IP-адрес, маску сети, шлюз по умолчанию и DNS-серверы.
</p>
<p>
По умолчанию на STA-интерфейсе включён DHCP-клиент, что эквивалентно команде:
<pre>
  esp32-sta><b>ip address dhcp</b>
</pre>
Эта команда указывает шеллу, что все сетевые параметры (адрес, маска, DNS и шлюз по умолчанию) будут получены от DHCP-сервера точки доступа.  
Если же нужно задать статический адрес, команда будет выглядеть так:
<pre>
  esp32-sta><b>ip address 192.168.0.2/24 gw 192.168.0.1</b>
</pre>
Маска сети указывается в формате CIDR (в примере — /24), то есть через длину префикса.  
В ESPShell не используются привычные записи масок вроде <b>255.255.255.0</b>.  
Если маску не указать, она считается равной /32 (255.255.255.255).  
При попытке установить такой адрес интерфейс автоматически скорректирует маску до /24.  
Маска /32 обычно используется в PPP-соединениях, которые ESPShell пока не поддерживает.
</p>
<p>
Если задать статический IP без указания маршрута по умолчанию (<b>gw</b> <i>A.B.C.D</i>), шелл автоматически подставит шлюз <b>A.B.C.1</b> — то есть заменит последний октет на 1.
</p>
<p>
Оба примера ниже эквивалентны:
<pre>
  esp32-sta><b>ip address 192.168.0.2/24 gw 192.168.0.1</b>
</pre>
<pre>
  esp32-sta><b>ip address 192.168.0.2</b>   &larr; маска /24, шлюз 192.168.0.1
</pre>
</p>
<p>
Другой пример: получать настройки от DHCP-сервера, но использовать статические DNS-серверы Google:
<pre>
  esp32-sta><b>ip address dhcp dns 8.8.8.8 dns 4.4.4.4</b>
</pre>
Чтобы задать два DNS-сервера (основной и резервный), перед каждым адресом добавляется ключевое слово <b>dns</b>.
</p>
</td></tr>

<tr><td><p>up</p></td><td>
<p><b>up</b> [<i>NETWORK_NAME_OR_MAC</i> [<i>PASSWORD</i> [<b>auto-reconnect</b>]]]</p>
<p>
Включает интерфейс (подключается к точке доступа).  
Команду <b>up</b> без параметров можно использовать для повторного подключения, если ESPShell помнит параметры предыдущего успешного соединения (см. <a href="#storage">storage</a>).
</p>
<p>
Обычно указываются два параметра — имя сети (или MAC, если SSID скрыт) и пароль.  
Для открытых сетей пароль можно опустить или указать пустые кавычки <b>&quot;&quot;</b>.
</p>
<p>
Примеры:
<pre>
  esp32-sta><b>up McDonalds_FREE</b>                    - без пароля  
  esp32-sta><b>up McDonalds_FREE "" auto-reconnect</b>  - без пароля, с авто-переподключением  
  esp32-sta><b>up McDonalds myPaSsword</b>              - с паролем  
  esp32-sta><b>up McDonalds myPaSsword auto-reconnect</b> - с паролем и авто-переподключением
</pre>
</p>
</td></tr>

<tr><td><p>down</p></td><td>
<p><b>down</b></p>
<p>
Отключает интерфейс: прерывает процесс подключения или разрывает активное соединение.
</p>
</td></tr>

<tr><td><p>mac</p></td><td>
<p><b>mac</b> <i>MAC_ADDRESS</i></p>
<p>
Задаёт новый MAC-адрес.  
Изменить MAC можно «на лету», но если STA-интерфейс уже подключён, смена адреса вызовет переподключение.
</p>
<p>
Шелл принимает разные форматы записи, например:
AA:BB:11:22:33:44, aaBB:1234:56Ff или 001122334455 — все они корректны.
</p>
<p>
Пример:
<pre>
  esp32-sta><b>mac 0044:afaf:dead</b>
</pre>
Нельзя задать MAC, совпадающий с уже используемым (например, у AP-интерфейса).  
Также не допускаются адреса, у которых установлен младший бит первого байта (адрес 0133:3333:3333 — некорректен, 0233:3333:3333 — корректен).  
Широковещательные адреса также не могут использоваться в качестве MAC интерфейса.
</p>
</td></tr>

<tr><td><p>hostname</p></td><td>
<p><b>hostname</b> <i>TEXT</i></p>
<p>
Задаёт новый hostname. В реализации от Espressif мы имеем уникальный hostname на каждом сетевом интерфейсе.  
</p>
<p>
Пример:
<pre>
  esp32-sta><b>hostname mars.local</b>
</pre>
</p>
</td></tr>

</table>


<p><h2 id=example_ap><a href="#top">&#8686;</a>Пример: создаем точку доступа и роутер</h2></p>
<p>
Самый простой способ создать точку доступа (AP) - это войти в режим wifi ap, и выполнить команду &quot;<b>up</b>&quot;. У команды &quot;<b>up</b>&quot; есть один обязательный и два необязательных параметра: имя создаваемой сети, пароль и максимальное количество клиентов, которым разрешено подключение.
Пример:
<pre>
  esp32-ap>up Barmalei78 MyP@ssworT max-conn 4
</pre>
Эта команда создаеь WiFi сеть "<b>Barmalei78</b>" с паролем MyP@ssworT и максимальным количеством соединений равным четырем (это де число является значением по умолчанию).
Пример создания сети без пароля, на одного клиента:
<pre>
  esp32-ap>up Barmalei78 "" max-conn 1
</pre>
Если параметр <b>max-conn</b> нам не нужен, то для сети без пароля можно ограничится командой

<pre>
  esp32-ap>up Barmalei78
</pre>
По умолчанию точка доступа сконфигурирована со следующими параметрами:
<ul>
<li>DHCP сервер : автостарт</li>
<li>Пул адресов : 192.168.4.2..192.168.4.254</li>
<li>IP адрес    : 192.168.4.1/24</li>
<li>DNS, Gateway: 192.168.4.1</li>
<li>NAT : выключен</li>
<li>Hostname : espressif</li>
<li>MAC : автоматический</li>
</ul>

После выполнения команды "<b>up</b>" ESP32 создает SoftAP (точку доступа) и начинает передавать в эфир название сети (SSID): можно подключаться.
Обратите внимание, что смена mac адреса точки доступа возможна лишь в случае, когда точка доступа запущена и слышна в эфире: т.е. сначала &quot;<b>up</b>&quot; а уж потом - "mac".
Такое поведение специфично для интерфейса AP. На интерфейсе STA менять mac адрес можно когда заблагорассудится
</p>

<p>
Хорошо, создали мы точку доступа, скажем, Barmalei78 с такими параметрами:
<pre>
  esp32-ap><b>up Barmalei78 PaSSword1923 max-conn 2</b>
</pre>
Можно ли создать маршрутизатор, если мы оживили оба интерфейса (STA и AP)? 
Да, можно. Для этого всего лишь нужно включить NAT на интерфейсе AP: делается это одной командой 
<pre>
  esp32-ap><b>nat enable</b>
</pre>
Теперь, если STA интерфейс подключен к Интернет, то клиенты нашей точки доступа (на интерейсе AP) так же будут иметь доступ в Интернет.
</p>
<p>
Пример: Подключиться интерфейсом STA к интернету (сеть "SomKiat Suksamran", password: "Khlong1822"), а интерфейсом AP раздавать интернет пользователям.
Раздавать интернет без пароля, а название сети будет "FreeWiFi".
<pre>
  esp32#>wifi sta
  esp32-sta>up "SomKiat Suksamran" Khlong1822
  esp32-sta>exit

  esp32#>wifi ap
  esp32-ap>up "FreeWiFi"
  esp32-ap>nat enable
  esp32-ap>exit
</pre>
</p>



<p><h2 id=ap><a href="#top">&#8686;</a>Точка доступа (AP)</h2></p>
<p>
Работа с AP-интерфейсом начинается с команды <b>wifi ap</b>.  
</p>

<table><tr><th>Команда</th><th>Описание</th></tr>
<tr><td><p>ip</p></td><td>
<p><b>ip address</b> <i>ADDRESS/PREFIX</i> [<b>dns</b> <i>ADDRESS</i>]*</p>
<p>
Задаёт статический или динамический IP-адрес, маску сети и DNS-серверы; задать шлюз по умолчанию так же возможно, через парамер gw как и в STA интерфейсе, но это , скорее всего, приведет к неработоспособности клиентов.


</p>

Обратите внимание: если не задать DNS, то, по умолчанию DNS адрес будет установлен таким же, как адрес интерфейса.
В таком случае, при установлении соединения по интерфейсу STA, настройки DNS серверов, полученные интерфейсом STA будут распостранены и на интерфейс AP. Чтобы запретить автоматическое изменение DNS серверов на интерфейсе AP, следует задать их явно, при задании IP адреса:
<pre>
  esp32-ap><b>ip address 192.168.4.1/24 dns 8.8.8.8</b>
</pre>

Если же адрес задать так:

<pre>
  esp32-ap><b>ip address 192.168.4.1/24</b>
</pre>

то DNS сервер будет установлен в 192.168.4.1, но как только STA интерфейс установит соединение и получит значения DNS серверов по DHCP,
настройки DNS AP тут же будут изменены. Такое поведение необходимо для работы в режиме маршрутизатора.

Так же, как и в интерфейсе STA, маска сети указывается в формате CIDR (в примере — /24), то есть через длину префикса.  
</p>

</td></tr>

<tr><td><p>up</p></td><td>
<p><b>up</b> [<i>NETWORK_NAME</i> [<i>PASSWORD</i> [<b>max-conn</b> <i>NUM</i>]]]</p>
<p>
Включает интерфейс (создает точку доступа).  
Команду <b>up</b> без параметров можно использовать для повторного подключения, если ESPShell помнит параметры предыдущего успешного соединения (см. <a href="#storage">storage</a>).
</p>
<p>
Обычно указываются два параметра — имя сети и пароль.  
Для открытых сетей пароль можно опустить или указать пустые кавычки <b>&quot;&quot;</b>. Дополнительно можно указать максимальное количество подключений к вашей точке, воспользовавшись ключевым словом <b>max-conn</b> (по умолчанию max-conn равен 4)
</p>
<p>
Примеры:
<pre>
  esp32-ap><b>up McDonalds_FREE</b>                    - Открытая сеть, без пароля, макс. 4 клиента
  esp32-ap><b>up McDonalds_FREE "" max-conn 1</b>      - без пароля, 1 клиент
  esp32-ap><b>up McDonalds myPaSsword</b>              - с паролем  
</pre>
</p>
</td></tr>

<tr><td><p>down</p></td><td>
<p><b>down</b></p>
<p>
Отключает интерфейс: выключает точку доступа, разрывает все установленные клиентами соединения.
</p>
</td></tr>

<tr><td><p>mac</p></td><td>
<p><b>mac</b> <i>MAC_ADDRESS</i></p>
<p>
Задаёт новый MAC-адрес.  
Интерфейс должен быть &quot;<b>up</b>&quot;, для того, чтобы можно было менять MAC адрес (это ограничение драйвера WiFi)
</p>
<p>
Шелл принимает разные форматы записи, например:
AA:BB:11:22:33:44, aaBB:1234:56Ff или 001122334455 — все они корректны.
</p>
<p>
Пример:
<pre>
  esp32-sta><b>mac 0044:afaf:dead</b>
</pre>
Нельзя задать MAC, совпадающий с уже используемым (например, у STA-интерфейса).  
Также не допускаются адреса, у которых установлен младший бит первого байта (адрес 0133:3333:3333 — некорректен, 0233:3333:3333 — корректен).  
Широковещательные адреса также не могут использоваться в качестве MAC интерфейса.
</p>
</td></tr>

<tr><td><p>hostname</p></td><td>
<p><b>hostname</b> <i>TEXT</i></p>
<p>
Задаёт новый hostname. В реализации от Espressif мы имеем уникальный hostname на каждом сетевом интерфейсе.  
</p>
<p>
Пример:
<pre>
  esp32-sta><b>hostname snikers.local</b>
</pre>
</p>
</td></tr>

<tr><td><p>dhcp</p></td><td>
<p><b>dhcp</b> <b>enable | disable</b></p>
<p><b>dhcp</b> <b>A.B.C.D [COUNT]</b></p>
<p>
Включить \ выключить DHCP сервер, задать диапазон выдаваемых клиентам IP адресов. Настройки по умолчанию:
<pre>
  esp32-ap>dhcp 192.168.4.2 15    &larr; выдавать адреса 192.168.4.2 ... 192.168.4.17
  esp32-ap>dhcp enable            &larr; включить DHCP сервер
</pre>
</p>
</td></tr>


<tr><td><p>nat</p></td><td>
<p><b>nat</b> <b>enable | disable</b></p>
<p>
Включить \ выключить NAT. Настройки по умолчанию:
<pre>
  esp32-ap>nat disable
</pre>
При включенном NAT, работающей точке доступа и установленному соединению на STA интерфейсе, ESP32 превратится в маленький маршрутизатор,
способный выдавать около 14мбит\сек работая удлинителем WiFi.
</p>
</td></tr>


<tr><td><p>kick</p></td><td>
<p><b>kick all</b> | <i>AID</i></p>
<p>
Отключить (деаутентифицировать) станцию с идентификатором AID (число от 1 до 65535, выводится в колонке "AID" команды "<b>show wifi clients</b>")
 или, если вместо идетификатора станции указано ключевое слово "<b>all</b>", все подключенные станции.
<pre>
  esp32-ap>kick all
  esp32-ap>kick 1
  esp32-ap>kick 4
</pre>
</p>
</td></tr>


</table>
</p>
<p><h2 id=show_clients><a href="#top">&#8686;</a>Отображение информации о клиентах</h2></p>
<p>
Для просмотра списка клиентов можно воспользоваться командой "<b>show wifi clients</b>". Команда выведет на экран список 
клиентов аутентифицированных нашей точкой доступа. Вывод команды выглядит следующим образом:
</p>
<p align=center>
<img src="i/show_wifi_clients.jpg" alt="show wifi clients" width="80%" height="80%" />
<br>
<i>Рис. 4: Вывод команды <b>show wifi clients</b></i>
</p>

<p><h2 id=storage><a href="#top">&#8686;</a>Запоминание настроек</h2></p>
<p>По умолчанию WiFi хранит все пользовательские настройки в памяти (RAM). Это означает, что при перезагрузке
эти данные будут потеряны и их придется вводить заново: имя сети, пароль, IP адрес и .т.п. Чтобы эту информацию не терять, следует воспользоваться командой "<b>wifi storage flash</b>". После
выполнения этой команды драйвер будет запоминать WiFi настройки и конфигурацию во внутренней flash памяти и считывать ее при перезагрузке.
Режим "<b>wifi storage flash</b>" нужно включать каждый раз после перезагрузки процессора: при перезагрузке значение "storage" всегда устанавливается в "ram".
</p>
<p>
ESPShell не активирует интерфейсы при старте, даже если знает пароли и имена сетей: это делает только пользователь и только вручную, посредством комманд &quot;<b>up</b>&quot; и "down". ESPShell будет хранить настройки во flash, и будет считывать их. Но для применения нужно будет исполнить команду &quot;<b>up</b>&quot; 
<b>без параметров</b>.
<pre>
  esp32#>wifi storage ram      &larr; значение по умолчанию: все хранится в RAM
  esp32#>wifi storage flash    &larr; все хранится во FLASH
</pre>

</p>



<p><h2 id=memory_footprint><a href="#top">&#8686;</a>Требования к ресурсам (память)</h2></p>


</body>
</html>
</body>
</html>
