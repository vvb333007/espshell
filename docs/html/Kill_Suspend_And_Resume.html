<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="espshell.css">
  <title>ESPShell : Process Control : kill, suspend and resume</title>
  <meta charset="UTF-8">
</head>
<body>
<p align=center><a href="index.html"><img src="i/espshell_logo.jpg" alt="ESPShell for Arduino :: Index" width="70%" height="70%" /></a></p>
<h3 align=center><a href="Kill_Suspend_And_Resume.ru.html">[ На русском ]</a>&nbsp;&harr;&nbsp;<a href="Kill_Suspend_And_Resume.html">[ English ]</a></h3>

<p>
  <ul>
    <li><a href="#show">Process information display : "show tasks"</a></li>  
    <li><a href="#process">Process Control</a></li>
    <li><a href="#suspend">Suspend, Resume and Kill</a></li>
    <li><a href="#prio">Task priorities, changing</a></li>
  </ul>
</p>

<p id="show"><h2><a href="#top">&#8686;</a>PROCESS INFORMATION DISPLAY</h2></p>

<p>
As in other cases, task information is available using the "<b>show</b>" command:
<table>
  <tr><th>Command</th><th>Description and examples</th></tr>
  <tr>
    <td><b>show tasks</b></td>
    <td>
      <p>Displays a list of running tasks, including their ID, priority, name, and state:
<pre>
esp32#><b>show ta</b>
%  # |  Task  ID  |        Name      | Prio |   State
%----+------------+------------------+------+-----------
%   1| 0x3fca300c |         ESPShell |   5  | Running
%   2| 0x3fca7264 |            IDLE0 |   0  | Ready
%   3| 0x3fca5f64 |              pin |   0  | Ready
%   4| 0x3fca783c |            IDLE1 |   0  | Ready
%   5| 0x3fcaace8 |         loopTask |   1  | Waiting
%   6| 0x3fca85f4 |          Tmr Svc |   1  | Waiting
%   7| 0x3fca1790 |             ipc1 |  24  | Suspended
%   8| 0x3fca11f8 |             ipc0 |  24  | Suspended
%   9| 0x3fca5484 |        esp_timer |  22  | Suspended
%----+------------+------------------+------+-----------
% Total: 9 tasks
esp32#>
</pre>

      </p>
    </td>
  </tr>
</table>      

</p>

<p id="process"><h2><a href="#top">&#8686;</a>PROCESS CONTROL</h2></p>

<p>
Process control is implemented through three commands: <b>suspend</b>, <b>resume</b>, <b>kill</b> and <b>priority</b>. By "processes," 
we mean FreeRTOS tasks. For example, the main Arduino <i>loop()</i> runs as a dedicated FreeRTOS task named "loop" -
so "<i>loop()</i>" is a process.
</p>

<p>
Access to tasks and their management is done by their TASK_ID (a hexadecimal number, for example "0x3fca370c") or by name,
except for the main Arduino loop() task: the execution of the main sketch can be controlled by omitting the TASK_ID
parameter in the command. That is, to suspend the sketch, instead of "suspend 0x12345678" you can use
the command "suspend" without arguments.
</p>
<p>
IMPORTANT: Several processes may have exactly the same names. This happens, for example, when multiple background commands are started, such as "pin":
<pre>
  esp32#>pin 2 low delay 100 high delay 100 loop infinite &
  esp32#>pin 4 low delay 200 high delay 200 loop infinite &
</pre>
The process list will then contain two processes with the identical name "pin". In this case, you should use the TASK_ID instead of the name. If you use the task name, the operation will be performed on the first task with that name in the list.
The task’s index in the list changes constantly and should not be relied upon.
</p>

<p>
Okay, but where can we get these task IDs and names?
</p>
<p>
For example, you can use the <b>show tasks</b> command:
<pre>
esp32#>show tasks
%  # |  Task  ID  |        Name      | Prio |   State
%----+------------+------------------+------+-----------
%   1| 0x3fca783c |            IDLE1 |   0  | Ready
%   2| 0x3fca7264 |            IDLE0 |   0  | Ready
%   3| 0x3fca300c |         ESPShell |   0  | Running
%   4| 0x3fca5f64 |              pin |   0  | Ready
%   5| 0x3fcaace8 |         loopTask |   1  | Waiting
%   6| 0x3fca1790 |             ipc1 |  24  | Suspended
%   7| 0x3fca11f8 |             ipc0 |  24  | Suspended
%   8| 0x3fca5484 |        esp_timer |  22  | Suspended
%   9| 0x3fca85f4 |          Tmr Svc |   1  | Waiting
%----+------------+------------------+------+-----------
% Total: 9 tasks
esp32#>
</pre>
Command displays all tasks, including system tasks started by FreeRTOS and tasks started by ESP-IDF.
</p>
<p>
Also, every ESPShell command that is run as a background process displays its TASK_ID. 
Let's say we execute the command "pin 2 delay 1000" in the background:
<pre>
esp32#>pin 2 delay 1000 &
% Background task started
% Copy/paste "kill 0x3ffb91dc" to abort
esp32#>
</pre>
This command doesn't do much -just waits for 1000ms. Once started, it prints its task ID along with 
a convenient "kill" command that can be copied and executed: "kill 0x3ffb91dc".
</p>

<p>
Another source of TASK_IDs is the "<b><a href="Pulse_Counter.html#show">show counters</a></b>" command.
</p>

<p id="suspend"><h2><a href="#top">&#8686;</a>SUSPEND, RESUME AND KILL</h2></p>

<table>
  <tr><th>Command</th><th>Description and examples</th></tr>

  <tr>
    <td><b>suspend</b></td>
    <td>
      <p>Pauses sketch execution by suspending Arduino's <b>loop()</b>. Tasks that were started by <b>loop()</b> 
      and <b>setup()</b> are <b>not suspended</b> by this command. Suspending a task along with all of its child tasks 
      is a planned but not yet implemented feature. Ctrl+C is a hotkey for the "<b>suspend</b>" command.</p>
    </td>
  </tr>

  <tr>
    <td><b>suspend</b>&nbsp;<i>TASK_ID|TASK_NAME</i></td>
    <td>
      <p><b>suspend</b> <i>TASK_ID | TASK_NAME</i></p>
      <p>Suspends an arbitrary task by its name or ID. The command requires one argument -a hexadecimal task ID or a task name. Please note that there may be several tasks with the same name (but IDs are different).</p>
    </td>
  </tr>

  <tr>
    <td><b>resume</b></td>
    <td>
      <p>Resumes sketch execution.</p>
    </td>
  </tr>

  <tr>
    <td><b>resume</b>&nbsp;<i>TASK_ID&nbsp;|&nbsp;TASK_NAME</i></td>
    <td>
      <p><b>resume</b> <i>TASK_ID | TASK_NAME</i></p>
      <p>Resumes an arbitrary task by its TASK_ID or by its TASK_NAME. The command requires one argument -a hexadecimal task ID or a name.</p>
    </td>
  </tr>

</table>

<p>
To stop an ESPShell task (ESPShell <a href="Basics.html#background">uses tasks</a> to run background commands) or any 
arbitrary FreeRTOS task, use the <b>kill</b> command:
</p>

<table>
  <tr><th>Command</th><th>Description and examples</th></tr>

  <tr>
    <td><b>kill</b>&nbsp;<i>TASK_ID|TASK_NAME</i></td>
    <td>
<p><b>kill</b> [-TERM | -15 | -KILL | -9] <i>TASK_ID</i></p>

<p>
Stops execution of the task with the given TASK_ID / TASK_NAME. If the "&" symbol is used at the end of a command,
ESPShell executes it in the background by spawning a new task:
<pre>
      esp32#>pin 2 delay 999 &
      % Background task started
      % Copy/paste "kill 0x3fca370c" command to stop execution  &larr; note the TASK_ID
      esp32#>
</pre>
Please note that any background command like the "pin 2 low ..." command will have the same task name: "pin". In such cases, use the TASK_ID to distinguish between different "pin" commands.
</p>
<p>
In the simplest case -when only the TASK_ID or TASK_NAME are provided - the command <i>sends a notification</i> to the task
in an attempt to initiate a graceful shutdown.
</p>

<p>
This command mimics the classic Linux <code>kill</code> command and accepts an optional signal parameter. 
<b>-9</b> or <b>-KILL</b> means forcibly terminate the task: no notification is sent; the task is 
suspended and then deleted via the FreeRTOS API <code>vTaskDelete()</code>. However, resources used by 
the task are not freed. Force-killing a task holding a mutex may result in system lockups.
</p>

<p>
All ESPShell-created tasks should normally be terminated this way -without using any additional parameters. 
However, there are examples of ESPShell commands that can only be terminated using <code>kill -9</code>. 
These special cases are described <a href="GPIO.html">in the documentation</a> for the "pin" command.
</p>

<p>
Using <b>-15</b>, <b>-TERM</b>, or no signal at all indicates a graceful shutdown: the task is not deleted 
but is given a chance to terminate itself and release any allocated resources.
</p>

<p>
Using <b>-9</b> or <b>-KILL</b> results in immediate task suspension and deletion via FreeRTOS 
<code>vTaskDelete()</code>. This is equivalent to the Linux <code>kill -9</code> command, but unlike its 
Linux counterpart, ESPShell does not release any memory or resources allocated by the task.
</p>
    </td>
  </tr>
</table>
<p id="prio"><h2><a href="#top">&#8686;</a>PROCESS PRIORITY, CHANGING PRIORITY</h2></p>

<p>Tasks managed by FreeRTOS are scheduled according to their assigned <i>priorities</i>. A priority value can range from 0 to 24 — the higher the number, the higher the priority.
</p><p>
System-level inter-core communication tasks — <b>ipc0</b> and <b>ipc1</b> — run with the highest priority. Bluetooth and Wi-Fi components operate with high priority, while so-called idle tasks — <b>IDLE0</b> and <b>IDLE1</b> — have the lowest.
</p><p>
By default, ESPShell starts with priority 0, which corresponds to the priority of system idle tasks. All auxiliary tasks created by the shell are also launched with the same priority. Tasks started by the shell (e.g., background commands) inherit this priority.
</p><p>
The priority can be changed using the "<b>priority</b> NUM [<i>TASK_ID | TASK_NAME</i>]" command. If the second parameter (task ID) is omitted, the new priority is applied to the shell itself. If provided, the specified task’s priority will be updated instead.
</p>
<p>
Example: check the current priority of the shell and change it to 5.
<pre>
esp32#><b>sh ta</b>
%  # |  Task  ID  |        Name      | Prio |   State
%----+------------+------------------+------+-----------
%   1| 0x3fca5f64 |              pin |   0  | Ready
%   2| 0x3fca7264 |            IDLE0 |   0  | Ready
%   3| 0x3fca300c |         <b>ESPShell</b> |   <b>0</b>  | Running
%   4| 0x3fca783c |            IDLE1 |   0  | Ready
%   5| 0x3fcaace8 |         loopTask |   1  | Waiting
%   6| 0x3fca11f8 |             ipc0 |  24  | Suspended
%   7| 0x3fca5484 |        esp_timer |  22  | Suspended
%   8| 0x3fca85f4 |          Tmr Svc |   1  | Waiting
%   9| 0x3fca1790 |             ipc1 |  24  | Suspended
%----+------------+------------------+------+-----------
% Total: 9 tasks
esp32#><b>prio 5</b>
esp32#>sh ta
%  # |  Task  ID  |        Name      | Prio |   State
%----+------------+------------------+------+-----------
%   1| 0x3fca300c |         <b>ESPShell</b> |   <b>5</b>  | Running
%   2| 0x3fca7264 |            IDLE0 |   0  | Ready
%   3| 0x3fca783c |            IDLE1 |   0  | Ready
%   4| 0x3fca5f64 |              pin |   0  | Ready
%   5| 0x3fcaace8 |         loopTask |   1  | Waiting
%   6| 0x3fca5484 |        esp_timer |  22  | Suspended
%   7| 0x3fca85f4 |          Tmr Svc |   1  | Waiting
...
</pre>
<b>Note on task priorities:</b> 
The shell command <b>pin 2 low high loop inf</b> generates a 150 kHz square wave when running with IDLE priority. However, when its priority is raised to 2, the frequency increases to 560 kHz.
This happens because the <b>pin</b> command never yields the CPU, preventing lower-priority system tasks from executing.
</p>
</body>
</html>
