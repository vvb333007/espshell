<!DOCTYPE html>
<html lang="en">
<head>
  <title>WiFi : configuring AP, STA, AP+STA, NAT, DHCP</title>
  <link rel="stylesheet" href="espshell.css">
  <meta charset="UTF-8">
</head>
<body>
<p align=center><a href="index.html"><img src="i/espshell_logo.jpg" alt="ESPShell for Arduino :: WiFi and networking" width="70%" height="70%" /></a></p>
<h3 align=center><a href="Wifi.ru.html">[ Russian ]</a>&nbsp;&harr;&nbsp;<a href="Wifi.html">[ English ]</a></h3>

<p>
  <ul>
    <li><a href="#intro">WiFi on ESP32</a></li>
    <li><a href="#interfaces">Network interfaces: AP and STA</a></li>
    <li><a href="#show">Displaying interface and network information</a></li>
    <li><a href="#scan">Scanning</a></li>
    <li><a href="#time">Time synchronization via NTP</a></li>
    <li><a href="#example">Example: connecting to an access point</a></li>
    <li><a href="#sta">Client (STA)</a></li>
    <li><a href="#example_ap">Example: creating an access point</a></li>
    <li><a href="#ap">Access Point (AP)</a></li>
    <li><a href="#show_clients">Displaying client information</a></li>
    <li><a href="#storage">Saving settings</a></li>
    <li><a href="#memory_footprint">Resource requirements (memory)</a></li>
 </ul>
</p>

<p><h2 id=intro><a href="#top">&#8686;</a>WiFi on ESP32</h2></p>
<p>
Most Espressif chips include a built-in WiFi module. This module was developed by third-party specialists,
so a significant part of the WiFi driver source code is unavailable. Instead of source code,
only compiled libraries and header files are provided.  
During WiFi initialization, microcode is loaded into an internal FPGA that implements all wireless interface functionality.
</p>

<p>
Some Espressif microcontrollers do not have <b>built-in</b> WiFi support. For example, the ESP32-P4 
uses a dual-MCU configuration where one of the MCUs acts as a WiFi module (the ESP32-P4 itself does not include WiFi).  
Note: ESPShell supports only chips with <b>hardware-integrated</b> WiFi (e.g., ESP32, ESP32-S3, ESP32-C6).
</p>

<p>
Arduino user sketches typically rely on the “standard” WiFi library for ESP32, which is a wrapper around ESP-IDF APIs.
ESPShell does not conflict with such sketches: even though it does not know anything about the WiFi Library,
it uses the same underlying API and does not store pointers to interfaces or their settings.  
If WiFi was initialized inside the user sketch, the shell correctly interacts with the <b>already running interface</b>.  
Moreover, one of the main use cases of ESPShell is the ability to <b>change network settings on the fly</b>—
override IP addresses, passwords, and SSIDs right during execution of the user application.
If the user sketch does not manage WiFi at all but wants to use BSD sockets, the user can manually configure
network interfaces and then resume the sketch (interrupt with Ctrl+C, continue with “resume”).
</p>

<p><h2 id=interfaces><a href="#top">&#8686;</a>Network interfaces: AP and STA</h2></p>
<p>
ESPShell supports two WiFi interfaces: <b>sta</b> (Station) and <b>ap</b> (Access Point).
The <b>sta</b> interface is used to connect to an existing network (e.g., Internet access),
and the <b>ap</b> interface is used to create your own access point.  
Both interfaces can be enabled simultaneously, which allows routing and NAT — effectively turning ESP32 into a WiFi extender.
</p>

<p>
As with other ESP32 interfaces, working with WiFi starts by switching to the desired mode.  
Run <b>wifi sta</b> or <b>wifi ap</b>:
<pre>
  esp32#>wifi sta
  esp32-sta>
</pre>

<pre>
  esp32#>wifi ap
  esp32-ap>
</pre>
</p>

<p>
To exit WiFi configuration mode, use <b>exit</b> (or press Ctrl+Z).
</p>

<p>
Note: To view WiFi settings (via "show wifi ..."), the interfaces must exist.  
They are created either by the user sketch (calling <i>WiFi.begin(...)</i>) or manually by executing any command
starting with "<b>wifi</b>" (for example, "<b>wifi sta</b>").
</p>

<p><h2 id=show><a href="#top">&#8686;</a>Displaying interface and network information</h2></p>
<p>
To display WiFi interface state and parameters, use <b>show wifi</b> with the required argument:
<pre>
  esp32#>show wifi ap      ← AP interface info
  esp32#>show wifi sta     ← STA interface info
  esp32#>show wifi clients ← information about STA clients connected to our AP
</pre>
Below is an example output of <b>show wifi sta</b> when no connection is established.  
The line “Configured:” shows information read from flash memory (if previously saved with <b>wifi storage flash</b>).
</p>

<p align=center>
<img src="i/show_wifi_sta_down.jpg" alt="show wifi sta down" width="80%" height="80%" />
<br>
<i>Fig. 1: Output of <b>show wifi sta</b> (no connection)</i>
</p>

<p><h2 id=scan><a href="#top">&#8686;</a>WiFi scanning</h2></p>
<p>
Scanning is used to retrieve the list of available networks and parameters of specific access points.
</p>

<p>
ESP32 supports two scanning modes: active (command <b>scan</b>) and passive (<b>scan passive</b>).
Active scanning sends WiFi Probe Requests and is the default.
If you add <b>passive</b>, ESPShell performs passive scanning: no packets are sent; the device simply listens.
<pre>
  esp32#><b>scan passive</b>
</pre>
</p>

<p>
If you pass <b>bssid</b> and a MAC address, you can obtain extended information about a specific AP:
<pre>
esp32-ap><b>scan bssid CC50:0AC2:3E44</b>
...
</pre>

Scanning is available for both interfaces (STA, AP, or AP+STA).
</p>

<p><h2 id=time><a href="#top">&#8686;</a>NTP time synchronization</h2></p>
<p>
While configuring WiFi, you can enable the NTP client, which periodically synchronizes time
with a remote server. NTP server addresses are obtained from DHCP by default.
If DHCP does not supply servers, static servers time.windows.com and pool.ntp.org are used.  
If DHCP does provide an NTP server, two static servers are added to it.
</p>

<p>
You may also configure only static NTP servers. In this case, DHCP-provided servers are ignored.
Up to three NTP servers are supported: one from DHCP and two (or all three) static.
</p>

<p>
By default, the NTP client is stopped. To start it, run "<b>ntp enable</b>" on any WiFi interface.
The "<b>ntp</b>" command supports chained arguments:
<pre>
  esp32-sta>ntp dhcp
  esp32-sta>ntp enable
</pre>
can be written as:
<pre>
  esp32-sta>ntp dhcp enable
</pre>
To use DHCP-provided NTP servers:
<pre>esp32-sta>ntp dhcp</pre>
To use your own servers:
<pre>esp32-sta>ntp pool.ntp.org</pre>
IP addresses are allowed as well.
</p>

<p>
Example: setting three static servers:
<pre>
  esp32-sta>ntp disable 1.1.1.1 time.windows.com 2.2.2.2
</pre>

Example: mixing DHCP + static:
<pre>
  esp32-sta>ntp 1.1.1.1 time.windows.com dhcp
</pre>

<b>Important:</b> for mixed mode, “dhcp” must appear <b>after</b> all static servers.
</p>

<p>
If WiFi is connected, an IP is obtained, and NTP servers configured, synchronization will occur within seconds.
Check with "<b>show time</b>".
</p>

<p><h2 id=example><a href="#top">&#8686;</a>Example: connecting to an access point</h2></p>
<p>
Before exploring commands in detail, let's connect to an available network.  
Enter STA configuration mode:
<pre>
  esp32#><b>wifi sta</b>
  esp32-sta>
</pre>
In this mode, commands for configuring the station interface become available.
Use <b>?</b> to list them:
</p>

<p align=center>
<img src="i/wifi_sta_commands_list.jpg" alt="WiFi STA commands list" width="80%" height="80%" />
<br>
<i>Fig. 2: Commands available in STA mode</i>
</p>

<p>
To display available networks, use <b>scan</b>.
<pre>
esp32-sta><b>scan</b>
...
</pre>
</p>

<p>
Choose “SomKiat Suksamran” and connect using password <b>Klong1414</b>.  
SSID contains spaces, so quotation marks are required.
Activation is done with <b>up</b>.
<pre>
esp32-sta>up "SomKiat Suksamran" Klong1414 auto
...
</pre>
</p>

<p align=center>
<img src="i/show_wifi_sta_up.jpg" alt="show wifi sta" width="80%" height="80%" />
<br>
<i>Fig. 3: Output of <b>show wifi sta</b> — connected</i>
</p>

<p>
Simple enough. Now — the details.
</p>

<p><h2 id=sta><a href="#top">&#8686;</a>Client (STA)</h2></p>
<p>
Working with the STA interface begins with <b>wifi sta</b>.  
It is recommended to configure the interface <b>before</b> connecting — especially when using a static IP.
Changing the IP after connecting will cause reconnection.
</p>

<table><tr><th>Command</th><th>Description</th></tr>

<tr><td><p>ip</p></td><td>
<p><b>ip address</b> <i>ADDRESS/PREFIX</i> | <b>dhcp</b> [<b>dns</b> <i>ADDRESS</i> | <b>gw</b> <i>ADDRESS</i>]*</p>
<p>
Sets static or dynamic IP, netmask, gateway and DNS servers.
</p>

<p>
By default, DHCP client is enabled:
<pre>
  esp32-sta><b>ip address dhcp</b>
</pre>
</p>

<p>
Static IP example:
<pre>
  esp32-sta><b>ip address 192.168.0.2/24 gw 192.168.0.1</b>
</pre>
Mask is in CIDR format.  
If omitted, /32 is assumed, but ESPShell auto-corrects it to /24 for typical WiFi usage.
</p>

<p>
If no gateway is provided, ESPShell assumes <b>A.B.C.1</b>.
</p>

<p>
Both examples below are equivalent:
<pre>
  esp32-sta><b>ip address 192.168.0.2/24 gw 192.168.0.1</b>
</pre>
<pre>
  esp32-sta><b>ip address 192.168.0.2</b>
</pre>
</p>

<p>
Example: DHCP + static DNS:
<pre>
  esp32-sta><b>ip address dhcp dns 8.8.8.8 dns 4.4.4.4</b>
</pre>
</td></tr>

<tr><td><p>up</p></td><td>
<p><b>up</b> [<i>NETWORK_NAME_OR_MAC</i> [<i>PASSWORD</i> [<b>auto-reconnect</b>]]]</p>
<p>
Enables the interface (connects to AP).
</p>

<p>
Examples:
<pre>
  esp32-sta><b>up McDonalds_FREE</b>
  esp32-sta><b>up McDonalds_FREE "" auto-reconnect</b>
  esp32-sta><b>up McDonalds myPaSsword</b>
  esp32-sta><b>up McDonalds myPaSsword auto-reconnect</b>
</pre>
</p>
</td></tr>

<tr><td><p>down</p></td><td>
<p><b>down</b></p>
<p>
Disconnects or aborts connection.
</p>
</td></tr>

<tr><td><p>mac</p></td><td>
<p><b>mac</b> <i>MAC_ADDRESS</i></p>
<p>
Sets MAC address.  
Changing the MAC while connected will trigger reconnection.
</p>

<p>
Formats accepted:  
AA:BB:11:22:33:44, aaBB:1234:56Ff, 001122334455.
</p>

<p>
Example:
<pre>
  esp32-sta><b>mac 0044:afaf:dead</b>
</pre>
</p>

<p>
The MAC must not collide with the AP interface.  
Multicast and broadcast MACs cannot be used.
</p>
</td></tr>

<tr><td><p>hostname</p></td><td>
<p><b>hostname</b> <i>TEXT</i></p>
<p>
Sets hostname. Espressif firmware supports unique hostnames per interface.
</p>

<p>
Example:
<pre>
  esp32-sta><b>hostname mars.local</b>
</pre>
</p>
</td></tr>

</table>

<p><h2 id=example_ap><a href="#top">&#8686;</a>Example: creating an access point and a router</h2></p>
<p>
The simplest way to create an access point (AP) is to switch to the wifi ap mode and run the "<b>up</b>" command.  
The "<b>up</b>" command has one required parameter and two optional ones: the network name, password, and the maximum number of clients allowed to connect.  
Example:
<pre>
  esp32-ap>up Barmalei78 MyP@ssworT max-conn 4
</pre>
This command creates a WiFi network "<b>Barmalei78</b>" with the password MyP@ssworT and a maximum of four connections (which is also the default value).  
Example of creating a network without a password, for a single client:
<pre>
  esp32-ap>up Barmalei78 "" max-conn 1
</pre>
If the <b>max-conn</b> parameter is not needed, then for an open (no-password) network you can simply run:
<pre>
  esp32-ap>up Barmalei78
</pre>
By default, the access point is configured with the following parameters:
<ul>
<li>DHCP server: auto-start</li>
<li>Address pool: 192.168.4.2..192.168.4.254</li>
<li>IP address: 192.168.4.1/24</li>
<li>DNS, Gateway: 192.168.4.1</li>
<li>NAT: disabled</li>
<li>Hostname: espressif</li>
<li>MAC: automatic</li>
</ul>

After executing the "<b>up</b>" command, the ESP32 creates a SoftAP (access point) and starts broadcasting the network name (SSID): clients can now connect.

Note that changing the AP interface’s MAC address is only possible when the access point is running and broadcasting — i.e., first "<b>up</b>", then "mac".
This behavior is specific to the AP interface. On the STA interface, the MAC address can be changed at any time.

</p>

<p>
Alright, suppose we created an access point called Barmalei78 with the following parameters:
<pre>
  esp32-ap><b>up Barmalei78 PaSSword1923 max-conn 2</b>
</pre>

Is it possible to create a router if both interfaces (STA and AP) are active?
Yes, it is. All you need is to enable NAT on the AP interface:

<pre>
  esp32-ap><b>nat enable</b>
</pre>

Now, if the STA interface is connected to the Internet, then clients connected to our access point (on the AP interface) will also have Internet access.

</p>

<p>
Example: connect the STA interface to the Internet (network "SomKiat Suksamran", password "Khlong1822"), and use the AP interface to share the Internet.  
The AP should be open (no password), with the network name "FreeWiFi".
<pre>
  esp32#>wifi sta
  esp32-sta>up "SomKiat Suksamran" Khlong1822
  esp32-sta>exit

esp32#>wifi ap
esp32-ap>up "FreeWiFi"
esp32-ap>nat enable
esp32-ap>exit </pre>

</p>

<p><h2 id=ap><a href="#top">&#8686;</a>Access Point (AP)</h2></p>
<p>
Working with the AP interface begins with the <b>wifi ap</b> command.
</p>

<table><tr><th>Command</th><th>Description</th></tr>

<tr><td><p>ip</p></td><td>
<p><b>ip address</b> <i>ADDRESS/PREFIX</i> [<b>dns</b> <i>ADDRESS</i>]*</p>
<p>
Sets a static or dynamic IP address, network mask, and DNS servers.  
It is also possible to set a default gateway via the <b>gw</b> parameter, same as on the STA interface — but this will most likely break client connectivity.
</p>

Note: if DNS is not specified, the default DNS will be set equal to the interface’s own address.
In this case, when the STA interface connects to a network and obtains DNS settings via DHCP, those DNS settings will also propagate to the AP interface.
To prevent automatic DNS changes on the AP interface, specify the DNS explicitly when setting the IP address:

<pre>
  esp32-ap><b>ip address 192.168.4.1/24 dns 8.8.8.8</b>
</pre>

If you set the address as follows:

<pre>
  esp32-ap><b>ip address 192.168.4.1/24</b>
</pre>

then the DNS server will be set to 192.168.4.1, but as soon as the STA interface establishes a connection and obtains DNS values, the AP DNS settings will automatically be updated.
This behavior is required for router mode.

As in the STA interface, the network mask is specified in CIDR format (in the example — /24), i.e., using the prefix length.

</td></tr>

<tr><td><p>up</p></td><td>
<p><b>up</b> [<i>NETWORK_NAME</i> [<i>PASSWORD</i> [<b>max-conn</b> <i>NUM</i>]]]</p>
<p>
Turns on the interface (creates an access point).  
You can use <b>up</b> without parameters for reconnecting if ESPShell remembers the parameters of a previous successful connection (see <a href="#storage">storage</a>).
</p>
<p>
Usually two parameters are given — network name and password.  
For open networks, the password may be omitted or replaced with empty quotes <b>&quot;&quot;</b>.  
Optionally, you can specify the maximum number of clients using the keyword <b>max-conn</b> (default is 4).
</p>

<p>Examples:
<pre>
  esp32-ap><b>up McDonalds_FREE</b>                    - Open network, no password, max 4 clients
  esp32-ap><b>up McDonalds_FREE "" max-conn 1</b>      - No password, 1 client
  esp32-ap><b>up McDonalds myPaSsword</b>              - With password
</pre>
</p>
</td></tr>

<tr><td><p>down</p></td><td>
<p><b>down</b></p>
<p>
Disables the interface: shuts down the access point and disconnects all connected clients.
</p>
</td></tr>

<tr><td><p>mac</p></td><td>
<p><b>mac</b> <i>MAC_ADDRESS</i></p>
<p>
Sets a new MAC address.  
The interface must be "<b>up</b>" in order to change the MAC address (this is a WiFi driver limitation).
</p>
<p>
The shell accepts several formats, for example:  
AA:BB:11:22:33:44, aaBB:1234:56Ff, or 001122334455 — all are valid.
</p>
<p>Example:
<pre>
  esp32-sta><b>mac 0044:afaf:dead</b>
</pre>
You cannot assign a MAC address already used by another interface (e.g., the STA interface).  
Also disallowed are addresses where the least significant bit of the first byte is set (0133:3333:3333 — invalid, 0233:3333:3333 — valid).  
Broadcast addresses cannot be used as interface MAC addresses.
</p>
</td></tr>

<tr><td><p>hostname</p></td><td>
<p><b>hostname</b> <i>TEXT</i></p>
<p>
Sets a new hostname.  
In Espressif’s implementation each network interface has its own hostname.
</p>
<p>Example:
<pre>
  esp32-sta><b>hostname snikers.local</b>
</pre>
</p>
</td></tr>

<tr><td><p>dhcp</p></td><td>
<p><b>dhcp</b> <b>enable | disable</b></p>
<p><b>dhcp</b> <b>A.B.C.D [COUNT]</b></p>
<p>
Enables/disables the DHCP server, sets the address pool for clients. Default settings:
<pre>
  esp32-ap>dhcp 192.168.4.2 15    ← assign addresses 192.168.4.2 ... 192.168.4.17
  esp32-ap>dhcp enable            ← enable the DHCP server
</pre>
</p>
</td></tr>

<tr><td><p>nat</p></td><td>
<p><b>nat</b> <b>enable | disable</b></p>
<p>
Enables/disables NAT. Default:
<pre>
  esp32-ap>nat disable
</pre>
With NAT enabled, the AP running, and the STA interface having an active connection, the ESP32 becomes a small router capable of delivering around 14 Mbit/s while working as a WiFi extender.
</p>
</td></tr>

<tr><td><p>kick</p></td><td>
<p><b>kick all</b> | <i>AID</i></p>
<p>
Disconnects (deauthenticates) a station by its AID (a number from 1 to 65535, shown in the "AID" column of the "<b>show wifi clients</b>" command),  
or all stations if the keyword "<b>all</b>" is used.
<pre>
  esp32-ap>kick all
  esp32-ap>kick 1
  esp32-ap>kick 4
</pre>
</p>
</td></tr>

</table>

<p><h2 id=show_clients><a href="#top">&#8686;</a>Displaying client information</h2></p>
<p>
To view the list of connected clients, use the "<b>show wifi clients</b>" command.  
The command displays a list of clients authenticated with our access point.  
The output looks like this:
</p>
<p align=center>
<img src="i/show_wifi_clients.jpg" alt="show wifi clients" width="80%" height="80%" />
<br>
<i>Fig. 4: Output of <b>show wifi clients</b></i>
</p>

<p><h2 id=storage><a href="#top">&#8686;</a>Saving configuration</h2></p>
<p>
By default, WiFi stores all user settings in RAM. This means that after a reboot, the settings will be lost and must be entered again: network name, password, IP address, etc.  
To persist these settings, use the "<b>wifi storage flash</b>" command. After executing it, the driver will store WiFi configuration in the internal flash memory and load it on reboot.  
The "<b>wifi storage flash</b>" mode must be enabled after each reboot: the storage mode always resets to "ram".
</p>
<p>
ESPShell does not automatically activate interfaces at startup, even if it knows the stored network names and passwords: activation is done only manually by the user using "<b>up</b>" and "down".  
ESPShell will store settings in flash and read them back, but to apply them, you must execute the "<b>up</b>" command <b>without parameters</b>.
<pre>
  esp32#>wifi storage ram      ← default: everything stored in RAM
  esp32#>wifi storage flash    ← store configuration in FLASH
</pre>
</p>

<p><h2 id=memory_footprint><a href="#top">&#8686;</a>Memory requirements</h2></p>
</body>


</html>
